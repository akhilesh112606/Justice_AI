<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JUSTICE AI - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.css"
    crossorigin="anonymous"
  />
  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.12.27/build/spline-viewer.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.js"
    crossorigin="anonymous"
    defer
  ></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; font-family: 'Space Grotesk', 'Sora', 'Manrope', system-ui, -apple-system, sans-serif; }
    body { background: radial-gradient(circle at 20% 20%, #121212, #090909 35%, #050505 70%, #000); color: #ffffff; overflow-x: hidden; position: relative; }
    body::after { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E"); pointer-events: none; z-index: 1; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes blob { 0%, 100% { transform: translate(0, 0) scale(1); } 25% { transform: translate(20px, -30px) scale(1.1); } 50% { transform: translate(-20px, 20px) scale(0.95); } 75% { transform: translate(30px, 10px) scale(1.05); } }
    @keyframes blob-2 { 0%, 100% { transform: translate(0, 0) scale(1); } 25% { transform: translate(-30px, 20px) scale(0.95); } 50% { transform: translate(25px, -15px) scale(1.1); } 75% { transform: translate(-15px, -25px) scale(0.98); } }
    @keyframes blob-3 { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 25% { transform: translate(calc(-50% + 15px), calc(-50% - 20px)) scale(1.08); } 50% { transform: translate(calc(-50% - 20px), calc(-50% + 15px)) scale(0.92); } 75% { transform: translate(calc(-50% + 25px), calc(-50% + 20px)) scale(1.05); } }
    @keyframes blob-slow { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(40px, -40px) scale(1.15); } }
    @keyframes blob-slow-reverse { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-35px, 35px) scale(1.12); } }
    .reveal { opacity: 1; }
    body.io-ready .reveal { opacity: 0; animation-play-state: paused; }
    body.io-ready .reveal.is-visible { opacity: 1; animation-play-state: running; }
    .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; }
    .animate-blob { animation: blob 8s ease-in-out infinite; }
    .animate-blob-2 { animation: blob-2 10s ease-in-out infinite; }
    .animate-blob-3 { animation: blob-3 12s ease-in-out infinite; }
    .animate-blob-slow { animation: blob-slow 15s ease-in-out infinite; }
    .animate-blob-slow-reverse { animation: blob-slow-reverse 18s ease-in-out infinite; }
    .grain-layer { position: absolute; inset: 0; pointer-events: none; background-image:
        radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.04) 0, transparent 30%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.03) 0, transparent 28%),
        radial-gradient(circle at 60% 70%, rgba(255, 255, 255, 0.04) 0, transparent 26%),
        repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.022), rgba(255, 255, 255, 0.022) 1px, transparent 1px, transparent 3px);
      mix-blend-mode: soft-light; opacity: 0.45; filter: contrast(1.05) brightness(0.98); }
    .spline-bg { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.45; filter: saturate(0) contrast(1.05); transform: scale(1.02); }
    .bg-orb { position: absolute; border-radius: 50%; filter: blur(80px); }
    .orb-1 { width: 420px; height: 420px; background: radial-gradient(circle, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.04)); top: -40px; left: 8%; }
    .orb-2 { width: 420px; height: 420px; background: radial-gradient(circle, rgba(255, 255, 255, 0.14), rgba(0, 0, 0, 0)); bottom: 5%; right: 4%; }
    .orb-3 { width: 360px; height: 360px; background: radial-gradient(circle, rgba(255, 255, 255, 0.22), rgba(0, 0, 0, 0)); top: 50%; left: 50%; }
    .orb-4 { width: 300px; height: 300px; background: radial-gradient(circle, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0)); top: 30%; right: 22%; }
    .orb-5 { width: 320px; height: 320px; background: radial-gradient(circle, rgba(255, 255, 255, 0.06), rgba(0, 0, 0, 0)); bottom: 28%; left: 30%; }
    .grid-overlay { position: absolute; inset: 0; background-image:
        linear-gradient(to right, rgba(255, 255, 255, 0.04) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255, 255, 255, 0.04) 1px, transparent 1px);
      background-size: 4rem 4rem; mask-image: radial-gradient(ellipse 60% 50% at 50% 50%, #000 70%, transparent 100%); }
    .gradient-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(255, 255, 255, 0.08), transparent, rgba(255, 255, 255, 0.08)); opacity: 0.35; }
    .vignette { position: absolute; inset: -8%; pointer-events: none; background: radial-gradient(circle at center, transparent 52%, rgba(0, 0, 0, 0.35) 75%, rgba(0, 0, 0, 0.55) 100%); mix-blend-mode: multiply; opacity: 0.6; }
    /* Corner badge to cover Spline watermark */
    .corner-badge { position: fixed; bottom: 16px; right: 16px; z-index: 9999; display: flex; align-items: center; gap: 8px; padding: 12px 18px; background: linear-gradient(135deg, rgba(12,14,18,0.96), rgba(6,8,12,0.98)); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; box-shadow: 0 10px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05) inset; backdrop-filter: blur(12px); pointer-events: none; }
    .corner-badge-dot { width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, #8af3ff, #5ed2ff); box-shadow: 0 0 10px rgba(138,243,255,0.8); animation: badgePulse 2s ease-in-out infinite; }
    .corner-badge-text { font-size: 12px; font-weight: 700; letter-spacing: 1.5px; color: rgba(255,255,255,0.85); text-transform: uppercase; }
    @keyframes badgePulse { 0%, 100% { opacity: 0.6; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } }
    .content { position: relative; z-index: 10; }
    .hero { padding-top: 80px; padding-bottom: 128px; text-align: center; }
    .hero-content { max-width: 960px; margin: 0 auto; }
    .hero-title { font-size: clamp(48px, 8vw, 92px); font-weight: 700; margin-bottom: 24px; background: linear-gradient(120deg, #ffffff 0%, #ffffff 50%, #ffffff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1.12; letter-spacing: -1px; animation: fadeInUp 1s ease-out 0.2s forwards; opacity: 0; }
    .hero-subtitle { font-size: 22px; color: #ffffff; margin-bottom: 24px; letter-spacing: 4px; text-transform: uppercase; animation: fadeInUp 1s ease-out 0.3s forwards; opacity: 0; }
    .hero-description { font-size: 18px; color: #ffffff; margin-bottom: 48px; max-width: 784px; margin-left: auto; margin-right: auto; animation: fadeInUp 1s ease-out 0.4s forwards; opacity: 0; }
    .card { margin: 0 auto; max-width: 960px; padding: 28px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 18px; backdrop-filter: blur(14px); box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset; animation: fadeInUp 1s ease-out 0.5s forwards; opacity: 0; }
    .card h3 { margin-bottom: 12px; font-size: 18px; letter-spacing: 0.5px; }
    .card pre { margin: 0; max-height: 420px; overflow: auto; padding: 18px; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; color: #ffffff; font-family: 'Space Grotesk', monospace; white-space: pre-wrap; }
    .editable-text { width: 100%; min-height: 240px; padding: 16px; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; color: #ffffff; font-family: 'Space Grotesk', monospace; font-size: 15px; resize: vertical; line-height: 1.6; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04); }
    .actions { display: flex; gap: 12px; justify-content: center; margin-top: 28px; }
    .btn-primary, .btn-secondary { cursor: pointer; border: none; }
    .btn-primary { padding: 14px 28px; background: linear-gradient(135deg, #ffffff, #b5b5b5 50%, #ffffff); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 14px; color: #050505; font-weight: 700; font-size: 16px; box-shadow: 0 18px 50px rgba(255, 255, 255, 0.12); transition: all 0.35s ease; }
    .btn-primary:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 22px 60px rgba(255, 255, 255, 0.18); }
    .btn-secondary { padding: 14px 28px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.18); border-radius: 14px; color: #f5f5f5; font-weight: 700; font-size: 16px; transition: all 0.3s ease; backdrop-filter: blur(12px); text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
    .btn-secondary:hover { transform: translateY(-2px) scale(1.02); border-color: rgba(255, 255, 255, 0.35); box-shadow: 0 16px 40px rgba(255, 255, 255, 0.12); }

    /* Question Deck */
    .section-header { display: grid; gap: 10px; align-items: start; text-align: center; margin: 0 auto 28px; max-width: 820px; }
    .pill { display: inline-flex; gap: 8px; align-items: center; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); border-radius: 999px; font-weight: 700; letter-spacing: 0.4px; width: fit-content; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .section-title { font-size: clamp(26px, 4vw, 34px); font-weight: 700; letter-spacing: -0.2px; }
    .section-sub { color: #d8d8d8; font-size: 15px; }

    /* Character selector + question viewer */
    .question-panel { display: grid; gap: 18px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); align-items: start; }
    .selector-stack { display: grid; gap: 12px; }
    .character-card { position: relative; padding: 14px 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; backdrop-filter: blur(10px); box-shadow: 0 18px 45px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05) inset; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: transform 0.35s ease, box-shadow 0.35s ease, border-color 0.35s ease; overflow: hidden; }
    .character-card::before { content: ''; position: absolute; inset: -45%; background: radial-gradient(circle, rgba(138,243,255,0.12), transparent 60%); opacity: 0; transition: opacity 0.35s ease, transform 0.45s ease; z-index: 0; }
    .character-card:hover { transform: translateY(-4px) scale(1.01); border-color: rgba(255,255,255,0.2); box-shadow: 0 24px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.08) inset; }
    .character-card:hover::before { opacity: 1; transform: scale(1.08); }
    .character-card.active { border-color: rgba(138,243,255,0.45); box-shadow: 0 26px 70px rgba(0,0,0,0.65), 0 0 0 1px rgba(138,243,255,0.4) inset; }
    .avatar { width: 44px; height: 44px; border-radius: 14px; background: linear-gradient(145deg, rgba(138,243,255,0.35), rgba(110,212,255,0.25)); border: 1px solid rgba(255,255,255,0.18); display: inline-flex; align-items: center; justify-content: center; font-weight: 800; letter-spacing: 0.5px; color: #0b161c; box-shadow: 0 14px 28px rgba(0,0,0,0.45); z-index: 1; }
    .character-meta { z-index: 1; display: grid; gap: 2px; text-align: left; }
    .character-name { font-weight: 700; letter-spacing: 0.2px; }
    .character-hint { color: #d0f8ff; font-size: 12px; opacity: 0.85; letter-spacing: 0.3px; }

    .viewer { position: relative; padding: 22px 22px 18px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; backdrop-filter: blur(12px); box-shadow: 0 24px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.06) inset; min-height: 260px; overflow: hidden; }
    .viewer::after { content: ''; position: absolute; inset: -30%; background: radial-gradient(circle, rgba(138,243,255,0.1), transparent 60%); opacity: 0.35; filter: blur(2px); }
    .viewer-content { position: relative; z-index: 1; display: grid; gap: 10px; }
    .viewer-label { display: inline-flex; gap: 8px; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.14); border-radius: 12px; font-weight: 700; width: fit-content; box-shadow: 0 10px 28px rgba(0,0,0,0.35); }
    .question-list { position: relative; z-index: 1; list-style: none; margin: 6px 0 0; padding: 0; display: grid; gap: 10px; }
    .question-list li { display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: start; color: #f5f5f5; font-size: 14px; line-height: 1.6; }
    .question-list li span:last-child { display: block; text-align: justify; }
    .question-bullet { width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, #8af3ff, #6ed4ff); margin-top: 6px; box-shadow: 0 0 10px rgba(138,243,255,0.65); }
    .status-dots { display: inline-flex; gap: 6px; position: relative; z-index: 1; }
    .status-dots span { width: 6px; height: 6px; border-radius: 50%; background: #8af3ff; animation: blink 1.2s ease-in-out infinite; }
    .status-dots span:nth-child(2) { animation-delay: 0.18s; }
    .status-dots span:nth-child(3) { animation-delay: 0.36s; }
    @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
    .empty-note { margin-top: 8px; color: #c9c9c9; font-size: 14px; text-align: left; }
    .selection-hint { font-size: 13px; color: #cfefff; opacity: 0.9; text-align: left; }
    svg { fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    /* Roadmap timeline - simplified vertical style */
    .roadmap-wrapper { margin-top: 56px; }
    .roadmap { position: relative; padding: 26px 18px 14px; background: rgba(12, 18, 26, 0.7); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; backdrop-filter: blur(12px); box-shadow: 0 20px 50px rgba(0,0,0,0.55); overflow: hidden; perspective: 1200px; }
    .roadmap::before { content: ''; position: absolute; left: 32px; top: 16px; bottom: 16px; width: 2px; background: linear-gradient(180deg, rgba(138,243,255,0.15), rgba(138,243,255,0.55), rgba(138,243,255,0.15)); filter: drop-shadow(0 0 6px rgba(138,243,255,0.5)); }
    .roadmap-steps { position: relative; display: grid; gap: 16px; padding: 4px 10px 12px 0; }
    .roadmap-step { position: relative; padding-left: 72px; }
    .roadmap-step::before { content: ''; position: absolute; left: 26px; top: 18px; width: 14px; height: 14px; border-radius: 50%; background: radial-gradient(circle, #8af3ff 0%, #6ed4ff 70%, rgba(110,212,255,0.15) 100%); box-shadow: 0 0 12px rgba(138,243,255,0.7); border: 1px solid rgba(255,255,255,0.25); }
    .step-card { position: relative; padding: 14px 16px; background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: 0 14px 34px rgba(0,0,0,0.45); transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease; transform-style: preserve-3d; overflow: hidden; }
    .step-card::after { content: ''; position: absolute; inset: -20%; background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.16), transparent 40%), linear-gradient(120deg, rgba(138,243,255,0.35), transparent 55%); opacity: 0; transition: opacity 0.35s ease; pointer-events: none; }
    .step-card:hover { transform: translateY(-4px) scale(1.01); border-color: rgba(138,243,255,0.55); box-shadow: 0 22px 50px rgba(0,0,0,0.55), 0 0 0 1px rgba(138,243,255,0.28) inset; filter: drop-shadow(0 0 12px rgba(138,243,255,0.2)); }
    .step-card:hover::after { opacity: 1; }
    .step-delete { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #e8f7ff; font-weight: 800; font-size: 14px; cursor: pointer; transition: all 0.2s ease; opacity: 0.75; display: inline-flex; align-items: center; justify-content: center; }
    .step-delete:hover { transform: translateY(-2px); border-color: rgba(255,80,80,0.5); color: #ffdddd; box-shadow: 0 10px 22px rgba(0,0,0,0.4); }
    .step-delete.disabled { pointer-events: none; opacity: 0.3; filter: grayscale(0.4); }
    .step-num { position: absolute; left: -56px; top: 14px; width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, rgba(138,243,255,0.25), rgba(110,212,255,0.18)); border: 1px solid rgba(255,255,255,0.12); display: inline-flex; align-items: center; justify-content: center; font-weight: 800; color: #0b161c; box-shadow: 0 12px 22px rgba(0,0,0,0.4); }
    .step-title { font-weight: 700; letter-spacing: 0.2px; margin-bottom: 6px; }
    .step-detail { color: #e8f7ff; font-size: 14px; line-height: 1.55; text-align: justify; }
    .roadmap-actions { display: flex; gap: 10px; flex-wrap: wrap; padding: 6px 6px 2px; }
    .btn-ghost { padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.05); color: #f5f5f5; font-weight: 700; cursor: pointer; transition: all 0.25s ease; }
    .btn-ghost:hover { transform: translateY(-2px); border-color: rgba(138,243,255,0.4); box-shadow: 0 16px 40px rgba(0,0,0,0.45); }
    .edit-hint { font-size: 13px; color: #cfefff; opacity: 0.9; margin-left: auto; align-self: center; }
    @media (max-width: 720px) {
      .roadmap::before { left: 22px; }
      .roadmap-step { padding-left: 62px; }
      .step-num { left: -46px; }
    }

    /* Map section */
    .map-wrapper { margin-top: 64px; }
    .map-card { padding: 18px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; backdrop-filter: blur(12px); box-shadow: 0 20px 50px rgba(0,0,0,0.55); }
    #map { width: 100%; height: 420px; border-radius: 14px; overflow: hidden; box-shadow: 0 16px 40px rgba(0,0,0,0.45); }
    .map-list { margin-top: 12px; display: grid; gap: 10px; }
    .map-item { padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); }
    .map-item-title { font-weight: 700; }
    .map-item-address { font-size: 13px; color: #dfefff; }
    .map-hint { margin-top: 10px; color: #cfefff; font-size: 13px; }
    /* Map popup styling for readability */
    .maplibregl-popup-content { background: #ffffff; color: #111111; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); font-family: 'Sora', 'Space Grotesk', system-ui, sans-serif; }
    .maplibregl-popup-content strong { color: #0b1720; }
    .maplibregl-popup-tip { border-top-color: #ffffff !important; border-bottom-color: #ffffff !important; }
    /* Chatbot Section */
    .chatbot-wrapper { margin: 64px auto 40px; max-width: 1200px; display: grid; gap: 18px; }
    .chat-shell { padding: 18px; border-radius: 20px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(14px); box-shadow: 0 22px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.06) inset; }
    .chatbot-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 18px; align-items: stretch; }
    @media (max-width: 900px) { .chatbot-container { grid-template-columns: 1fr; } .chat-panel { height: 500px; } }
    .chatbot-robot { border-radius: 16px; overflow: hidden; background: radial-gradient(circle at 20% 20%, rgba(138,243,255,0.12), transparent 55%), rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); min-height: 460px; position: relative; box-shadow: 0 18px 50px rgba(0,0,0,0.55); }
    .chatbot-robot spline-viewer { width: 100%; height: calc(100% + 50px); min-height: 510px; display: block; position: relative; top: 0; margin-bottom: -50px; }
    .chat-panel { display: flex; flex-direction: column; border-radius: 16px; background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03)); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px); box-shadow: 0 18px 50px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.05) inset; overflow: hidden; min-height: 460px; height: 520px; }
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 14px; max-height: 360px; }
    .chat-message { padding: 12px 16px; border-radius: 14px; max-width: 88%; animation: fadeIn 0.3s ease; box-shadow: 0 10px 28px rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.06); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .chat-message.bot { background: linear-gradient(135deg, rgba(138,243,255,0.22), rgba(110,212,255,0.14)); border-color: rgba(138,243,255,0.35); align-self: flex-start; }
    .chat-message.user { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.12); align-self: flex-end; }
    .chat-message .sender { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #8fb5d5; margin-bottom: 4px; }
    .chat-message .text { font-size: 14px; line-height: 1.5; color: #f0f8ff; }
    .chat-input-area { padding: 16px; border-top: 1px solid rgba(255,255,255,0.08); display: flex; gap: 12px; background: rgba(255,255,255,0.02); }
    .chat-input { flex: 1; padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: #fff; font-size: 14px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
    .chat-input:focus { border-color: rgba(138,243,255,0.45); box-shadow: 0 0 0 3px rgba(138,243,255,0.15); }
    .chat-input::placeholder { color: #8fb5d5; }
    .chat-send-btn { padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.14); background: linear-gradient(135deg, #8af3ff, #5ed2ff); color: #0b1720; font-weight: 800; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 12px 30px rgba(94,210,255,0.35); }
    .chat-send-btn:hover { transform: translateY(-2px); box-shadow: 0 16px 40px rgba(94,210,255,0.45); }
    .chat-send-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }
    .chat-disclaimer { padding: 12px 16px; border-radius: 12px; background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.25); text-align: center; font-size: 12px; color: #fbbf24; box-shadow: 0 10px 28px rgba(0,0,0,0.35); }
    .typing-indicator { display: inline-flex; gap: 4px; padding: 10px 12px; }
    .typing-dot { width: 8px; height: 8px; border-radius: 50%; background: #8fb5d5; animation: typingBounce 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
    /* Character profile card */
    .profile-card { margin: 0 auto 32px; max-width: 960px; padding: 20px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; backdrop-filter: blur(12px); box-shadow: 0 18px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05) inset; display: grid; gap: 10px; text-align: left; }
    .profile-header { display: flex; gap: 10px; align-items: center; font-weight: 700; font-size: 18px; }
    .profile-field { display: grid; gap: 4px; padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); }
    .profile-label { font-size: 12px; letter-spacing: 0.3px; color: #cfefff; text-transform: uppercase; }
    .profile-value { font-size: 15px; color: #f7fbff; }
    .profile-muted { color: #9fb5c8; font-size: 14px; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; backdrop-filter: blur(4px); }
    .loading-overlay.visible { opacity: 1; pointer-events: all; }
    .loading-box { padding: 22px 28px; border-radius: 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 24px 60px rgba(0,0,0,0.55); display: grid; gap: 10px; text-align: center; }
    .spinner { width: 44px; height: 44px; border: 4px solid rgba(255,255,255,0.2); border-top-color: #ffffff; border-radius: 50%; margin: 0 auto; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Report export section */
    .report-wrapper { margin: 72px auto 40px; max-width: 960px; }
    .report-card { position: relative; padding: 22px 22px 20px; border-radius: 20px; background: radial-gradient(circle at 0% 0%, rgba(138,243,255,0.16), transparent 52%), rgba(12,16,24,0.9); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(18px); box-shadow: 0 26px 70px rgba(0,0,0,0.65), 0 0 0 1px rgba(255,255,255,0.04) inset; overflow: hidden; }
    .report-card::before { content: ''; position: absolute; inset: -40%; background: radial-gradient(circle at 10% 0%, rgba(138,243,255,0.24), transparent 55%), radial-gradient(circle at 90% 120%, rgba(255,255,255,0.18), transparent 60%); opacity: 0.3; mix-blend-mode: screen; pointer-events: none; }
    .report-actions { position: relative; z-index: 1; display: grid; gap: 14px; }
    .report-actions form { margin: 0; }
    .report-email-row { display: grid; grid-template-columns: minmax(0, 1.8fr) auto; gap: 12px; align-items: center; }
    .report-input { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.35); color: #f5f5f5; font-size: 14px; font-family: 'Space Grotesk', system-ui, sans-serif; outline: none; transition: border-color 0.2s, box-shadow 0.2s, background 0.2s; }
    .report-input::placeholder { color: #8fb5d5; }
    .report-input:focus { border-color: rgba(138,243,255,0.55); box-shadow: 0 0 0 3px rgba(138,243,255,0.18); background: rgba(0,0,0,0.5); }
    .report-btn-3d { position: relative; transform-style: preserve-3d; box-shadow: 0 18px 50px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.06) inset; }
    .report-btn-3d:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 22px 60px rgba(0,0,0,0.7), 0 0 0 1px rgba(138,243,255,0.35) inset; }
    .report-hint { position: relative; z-index: 1; margin-top: 10px; font-size: 12px; color: #cfefff; opacity: 0.9; text-align: left; }
    @media (max-width: 720px) {
      .report-email-row { grid-template-columns: 1fr; }
    }

    /* Email toast + tick animation */
    .email-toast { position: fixed; right: 24px; bottom: 24px; z-index: 9999; padding: 12px 16px; border-radius: 16px; background: radial-gradient(circle at 0 0, rgba(138,243,255,0.36), transparent 55%), rgba(6,14,22,0.96); border: 1px solid rgba(138,243,255,0.5); box-shadow: 0 18px 40px rgba(0,0,0,0.75); display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none; transform: translateY(12px) scale(0.9); transition: opacity 0.25s ease, transform 0.25s ease; }
    .email-toast.visible { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); }
    .email-toast-icon { position: relative; width: 26px; height: 26px; border-radius: 999px; border: 2px solid rgba(138,243,255,0.9); box-shadow: 0 0 18px rgba(138,243,255,0.9); display: inline-flex; align-items: center; justify-content: center; overflow: hidden; }
    .email-toast-icon::before, .email-toast-icon::after { content: ''; position: absolute; background: linear-gradient(135deg, #8af3ff, #5ed2ff); border-radius: 999px; }
    /* Crazy "sending" orbit ring */
    .email-toast.sending .email-toast-icon::before { width: 140%; height: 2px; top: 50%; left: -20%; transform-origin: center; animation: emailOrbit 0.7s linear infinite; }
    .email-toast.sending .email-toast-icon::after { width: 4px; height: 4px; border-radius: 50%; box-shadow: 0 0 10px rgba(138,243,255,0.8); animation: emailSpark 0.7s linear infinite; }
    /* Checkmark state */
    .email-toast.success .email-toast-icon { background: radial-gradient(circle at 30% 0%, rgba(255,255,255,0.35), transparent 60%), linear-gradient(135deg, #8af3ff, #5ed2ff); animation: emailPop 0.35s ease-out forwards; }
    .email-toast.success .email-toast-icon::before { width: 4px; height: 10px; border-radius: 999px; background: #041016; box-shadow: none; transform: rotate(45deg) translate(1px, 0); bottom: 7px; left: 11px; animation: none; }
    .email-toast.success .email-toast-icon::after { width: 4px; height: 18px; border-radius: 999px; background: #041016; box-shadow: none; transform: rotate(-45deg) translate(1px, 1px); bottom: 3px; left: 15px; animation: none; }
    .email-toast.error { border-color: rgba(252, 165, 165, 0.9); box-shadow: 0 18px 40px rgba(127,29,29,0.7); }
    .email-toast.error .email-toast-icon { border-color: rgba(252,165,165,0.9); box-shadow: 0 0 18px rgba(252,165,165,0.9); }
    .email-toast-text { font-size: 13px; color: #e8f7ff; }
    @keyframes emailOrbit { 0% { transform: rotate(0deg) translateX(0); } 50% { transform: rotate(180deg) translateX(3px); } 100% { transform: rotate(360deg) translateX(0); } }
    @keyframes emailSpark { 0% { transform: rotate(0deg) translate(10px, -2px); opacity: 1; } 50% { transform: rotate(180deg) translate(-4px, 2px); opacity: 0.6; } 100% { transform: rotate(360deg) translate(10px, -2px); opacity: 1; } }
    @keyframes emailPop { 0% { transform: scale(0.4); } 70% { transform: scale(1.15); } 100% { transform: scale(1); } }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <div>Scanning again… please wait</div>
    </div>
  </div>

  <div class="background">
    <spline-viewer class="spline-bg" url="https://prod.spline.design/fXcrKO8RVlhTuX6A/scene.splinecode"></spline-viewer>
    <div class="grain-layer"></div>
    <div class="bg-orb orb-1 animate-blob"></div>
    <div class="bg-orb orb-2 animate-blob-2"></div>
    <div class="bg-orb orb-3 animate-blob-3"></div>
    <div class="bg-orb orb-4 animate-blob-slow"></div>
    <div class="bg-orb orb-5 animate-blob-slow-reverse"></div>
    <div class="grid-overlay"></div>
    <div class="gradient-overlay"></div>
    <div class="vignette"></div>
  </div>

  <!-- Corner badge to cover Spline watermark -->
  <div class="corner-badge">
    <div class="corner-badge-dot"></div>
    <span class="corner-badge-text">Justice AI</span>
  </div>

  <div class="content">
    <section class="hero">
      <div class="hero-content">
        <h1 class="hero-title reveal">Dashboard</h1>
        <p class="hero-subtitle reveal">Extracted FIR Text</p>
        <p class="hero-description reveal">Review the OCR output below. You can return to upload another FIR image anytime.</p>

        <form id="rescan-form" class="reveal" method="post" action="/rescan">
          <div class="card">
            <h3>Extracted Content</h3>
            <textarea name="edited_text" class="editable-text" aria-label="Editable extracted text">{{ extracted_text }}</textarea>
          </div>

          <div class="actions">
            <button type="submit" class="btn-primary" id="scan-again-btn">Scan Again</button>
            <a href="/" class="btn-secondary">Upload Another</a>
          </div>
        </form>
        
          <div class="section-header reveal" style="margin-top: 40px;">
            <div class="pill">
              <div class="status-dots"><span></span><span></span><span></span></div>
              <span>Character info</span>
            </div>
            <div class="section-title">People detected in FIR</div>
            <div class="section-sub">Tap a character to view their phone, address, and notes.</div>
          </div>

          <div class="profile-card reveal" id="profile-card">
            <div class="profile-header" id="profile-name">Select a character</div>
            <div class="profile-field">
              <div class="profile-label">Phone</div>
              <div class="profile-value" id="profile-phone">—</div>
            </div>
            <div class="profile-field">
              <div class="profile-label">Address</div>
              <div class="profile-value" id="profile-address">—</div>
            </div>
            <div class="profile-field">
              <div class="profile-label">Notes</div>
              <div class="profile-value" id="profile-notes">—</div>
            </div>
            <div class="profile-muted" id="profile-hint">Click a character card to load details.</div>
          </div>

        <div class="section-header reveal" style="margin-top: 54px;">
          <div class="pill">
            <div class="status-dots"><span></span><span></span><span></span></div>
            <span>AI-curated investigation cues</span>
          </div>
          <div class="section-title">Dynamic FIR Questions</div>
          {% if character_questions and character_questions|length > 0 %}
            <div class="section-sub">Grouped by detected characters; tailored to the uploaded FIR.</div>
          {% else %}
            <div class="section-sub">No clear characters detected — showing general high-value questions.</div>
          {% endif %}
        </div>

        <div class="question-panel reveal">
          <div class="selector-stack">
            {% if character_questions and character_questions|length > 0 %}
              {% for character in character_questions %}
                <div class="character-card" data-name="{{ character.name }}" data-questions='{{ character.questions | tojson }}'>
                  <div class="avatar">{{ character.name[:2] | upper }}</div>
                  <div class="character-meta">
                    <div class="character-name">{{ character.name }}</div>
                    <div class="character-hint">Tap to see tailored prompts</div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="character-card active" data-name="General" data-questions='{{ general_questions | tojson }}'>
                <div class="avatar">GN</div>
                <div class="character-meta">
                  <div class="character-name">General prompts</div>
                  <div class="character-hint">Fallback when no names detected</div>
                </div>
              </div>
              <p class="selection-hint">No characters detected; general high-value questions available.</p>
            {% endif %}
          </div>

          <div class="viewer" id="viewer">
            <div class="viewer-content">
              <div class="viewer-label"><span class="chip-dot"></span><span id="viewer-name">{{ character_questions[0].name if character_questions and character_questions|length > 0 else 'General' }}</span></div>
              <ul class="question-list" id="viewer-list">
                {% if character_questions and character_questions|length > 0 %}
                  {% for q in character_questions[0].questions %}
                    <li><span class="question-bullet"></span><span>{{ q }}</span></li>
                  {% endfor %}
                {% else %}
                  {% for q in general_questions %}
                    <li><span class="question-bullet"></span><span>{{ q }}</span></li>
                  {% endfor %}
                {% endif %}
              </ul>
              <div class="empty-note" id="empty-note" style="display: none;">No questions available.</div>
            </div>
          </div>
        </div>

        <div class="roadmap-wrapper reveal">
          <div class="section-header" style="margin-bottom: 22px;">
            <div class="pill">
              <div class="status-dots"><span></span><span></span><span></span></div>
              <span>Investigation roadmap</span>
            </div>
            <div class="section-title">Step-by-step process</div>
            <div class="section-sub">Start points and next efficient moves, auto-drafted from the FIR context. Click a step to edit.</div>
          </div>

          <div class="roadmap">
            <div class="roadmap-track"></div>
            <div class="roadmap-steps" id="roadmap-steps">
              {% for step in roadmap_steps %}
                <div class="roadmap-step" data-index="{{ loop.index0 }}">
                  <div class="step-card" tabindex="0">
                    <button class="step-delete disabled" aria-label="Delete step">×</button>
                    <div class="step-num">{{ loop.index }}</div>
                    <div class="step-title" contenteditable="false">{{ step.title }}</div>
                    <div class="step-detail" contenteditable="false">{{ step.detail }}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="roadmap-actions">
              <button class="btn-ghost" id="toggle-edit">Enable Editing</button>
              <button class="btn-ghost" id="add-step">Add Step</button>
              <span class="edit-hint">Changes are local and not yet saved server-side.</span>
            </div>
          </div>
        </div>

        <div class="map-wrapper reveal">
          <div class="section-header" style="margin-bottom: 16px;">
            <div class="pill">
              <div class="status-dots"><span></span><span></span><span></span></div>
              <span>Locations from FIR</span>
            </div>
            <div class="section-title">Mapped addresses</div>
            <div class="section-sub">Detected places rendered on the map; titles come from FIR context.</div>
          </div>
          <div class="map-card">
            <div id="map"></div>
            <div class="map-hint" id="map-hint">
              {% if locations and locations|length > 0 %}
                Geocoding FIR locations…
              {% else %}
                No locations detected in text. Showing default map view.
              {% endif %}
            </div>
            <div class="map-list">
              {% if locations and locations|length > 0 %}
                {% for loc in locations %}
                  <div class="map-item">
                    <div class="map-item-title">{{ loc.title }}</div>
                    <div class="map-item-address">{{ loc.address }}</div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="map-item">
                  <div class="map-item-title">No locations found</div>
                  <div class="map-item-address">Edit the text or rescan to detect places.</div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Chatbot Section -->
      <div class="chatbot-wrapper reveal">
        <div class="section-header" style="margin-bottom: 10px;">
          <div class="pill">
            <div class="status-dots"><span></span><span></span><span></span></div>
            <span>AI Investigation Advisor</span>
          </div>
          <div class="section-title">Case-aware chatbot</div>
          <div class="section-sub">Advisory-only answers grounded in this FIR—ask for clarifications, leads, or inconsistencies.</div>
        </div>

        <div class="chat-shell">
          <div class="chatbot-container">
            <div class="chatbot-robot">
              <spline-viewer url="https://prod.spline.design/oNMzWOQrsYUZkE-4/scene.splinecode"></spline-viewer>
            </div>
            <div class="chat-panel">
              <div class="chat-messages" id="chat-messages">
                <div class="chat-message bot">
                  <div class="sender">AI Advisor</div>
                  <div class="text">Hello! I'm your AI Investigation Advisor. I'm using the FIR content on this page. Ask about people, timeline, evidence gaps, or next steps.</div>
                </div>
              </div>
              <div class="chat-input-area">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask about the case..." autocomplete="off">
                <button class="chat-send-btn" id="chat-send-btn">Send</button>
              </div>
              <div class="chat-disclaimer" style="margin: 0 16px 14px;">
                ⚠️ <strong>Disclaimer:</strong> Advisory insights only. Verify independently—this is not legal advice.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Export Section -->
      <div class="report-wrapper reveal">
        <div class="section-header" style="margin-bottom: 10px;">
          <div class="pill">
            <div class="status-dots"><span></span><span></span><span></span></div>
            <span>Case report export</span>
          </div>
          <div class="section-title">Export &amp; share report</div>
          <div class="section-sub">Download a full PDF brief of this FIR or send it directly over email.</div>
        </div>

        <div class="report-card">
          <div class="report-actions">
            <form id="download-report-form" method="post" action="/report/pdf">
              <input type="hidden" name="report_text" id="download-report-text">
              <button type="submit" class="btn-primary report-btn-3d">Download PDF Report</button>
            </form>

            <form id="email-report-form" method="post" action="/report/email">
              <input type="hidden" name="report_text" id="email-report-text">
              <div class="report-email-row">
                <input
                  type="email"
                  name="email"
                  id="report-email-input"
                  class="report-input"
                  placeholder="Enter email address to send report"
                  required
                >
                <button type="submit" class="btn-secondary report-btn-3d">Email PDF Report</button>
              </div>
            </form>
          </div>
          <div class="report-hint">
            Uses the current edited FIR text and AI-generated insights to produce a concise multi-section PDF. Email delivery relies on secure SMTP credentials configured on the server.
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Email status toast -->
  <div class="email-toast" id="email-toast" aria-live="polite" aria-atomic="true">
    <div class="email-toast-icon"></div>
    <div class="email-toast-text" id="email-toast-text">Sending report…</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js" crossorigin="anonymous"></script>
  <script>
    document.body.classList.add('io-ready');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
        }
      });
    }, { threshold: 0.25, rootMargin: '0px 0px -10% 0px' });
    document.querySelectorAll('.reveal').forEach((el) => observer.observe(el));

    const rescanForm = document.getElementById('rescan-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    const scanBtn = document.getElementById('scan-again-btn');
    if (rescanForm) {
      rescanForm.addEventListener('submit', () => {
        if (scanBtn) {
          scanBtn.disabled = true;
          scanBtn.textContent = 'Scanning...';
        }
        if (loadingOverlay) {
          loadingOverlay.classList.add('visible');
        }
      });
    }

    // Character selector interactions
    const cards = Array.from(document.querySelectorAll('.character-card'));
    const viewerName = document.getElementById('viewer-name');
    const viewerList = document.getElementById('viewer-list');
    const emptyNote = document.getElementById('empty-note');
    const profileName = document.getElementById('profile-name');
    const profilePhone = document.getElementById('profile-phone');
    const profileAddress = document.getElementById('profile-address');
    const profileNotes = document.getElementById('profile-notes');
    const profileHint = document.getElementById('profile-hint');
    // Case-insensitive profile map to better match character cards from questions
    const profileMap = new Map();
    const profileData = {{ character_profiles | tojson }} || [];
    console.log('[DEBUG] profileData from server:', profileData);
    profileData.forEach((p) => {
      if (p && p.name) {
        profileMap.set(p.name.toLowerCase(), p);
        console.log('[DEBUG] Added profile:', p.name, p);
      }
    });
    console.log('[DEBUG] profileMap size:', profileMap.size);

    const renderQuestions = (name, questions) => {
      viewerName.textContent = name || 'General';
      viewerList.innerHTML = '';
      if (!questions || questions.length === 0) {
        emptyNote.style.display = 'block';
        return;
      }
      emptyNote.style.display = 'none';
      questions.forEach((q) => {
        const li = document.createElement('li');
        const bullet = document.createElement('span');
        bullet.className = 'question-bullet';
        const text = document.createElement('span');
        text.textContent = q;
        li.appendChild(bullet);
        li.appendChild(text);
        viewerList.appendChild(li);
      });
    };

    const renderProfile = (name) => {
      if (!profileName || !profilePhone || !profileAddress || !profileNotes) return;
      const key = (name || '').toLowerCase();
      console.log('[DEBUG] renderProfile called with name:', name, 'key:', key);
      console.log('[DEBUG] profileMap keys:', Array.from(profileMap.keys()));
      let data = profileMap.get(key);
      // Fuzzy fallback: try contains match
      if (!data) {
        for (const [k, v] of profileMap.entries()) {
          if (k.includes(key) || key.includes(k)) { 
            console.log('[DEBUG] Fuzzy match found:', k, 'for', key);
            data = v; 
            break; 
          }
        }
      }
      console.log('[DEBUG] Final data for profile:', data);
      profileName.textContent = data?.name || name || 'Unknown';
      profilePhone.textContent = data?.phone || 'Not captured in FIR';
      profileAddress.textContent = data?.address || 'Not captured in FIR';
      profileNotes.textContent = data?.notes || 'No additional notes found';
      if (profileHint) profileHint.textContent = data ? 'Details from FIR context.' : 'No details available for this name.';
    };

    cards.forEach((card) => {
      card.addEventListener('click', () => {
        cards.forEach((c) => c.classList.remove('active'));
        card.classList.add('active');
        const name = card.dataset.name || 'General';
        let questions = [];
        try {
          questions = JSON.parse(card.dataset.questions || '[]');
        } catch (e) {
          questions = [];
        }
        renderQuestions(name, questions);
        renderProfile(name);
      });
    });

    // Initial render for first card if available
    if (cards.length > 0) {
      const first = cards[0];
      first.click();
    }

    // Roadmap editing
    const roadmapSteps = document.getElementById('roadmap-steps');
    const toggleEditBtn = document.getElementById('toggle-edit');
    const addStepBtn = document.getElementById('add-step');
    let editEnabled = false;

    // 3D tilt interaction for roadmap cards
    const attachCardInteractions = (card) => {
      card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        const rotateY = ((x - centerX) / centerX) * 6; // tilt range
        const rotateX = -((y - centerY) / centerY) * 6;
        card.style.transform = `translateY(-4px) scale(1.01) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      });
      card.addEventListener('mouseleave', () => {
        card.style.transform = '';
      });
    };

    document.querySelectorAll('.step-card').forEach(attachCardInteractions);

    const setEditable = (enabled) => {
      roadmapSteps.querySelectorAll('.step-title, .step-detail').forEach((el) => {
        el.contentEditable = enabled ? 'true' : 'false';
        el.style.outline = enabled ? '1px dashed rgba(138,243,255,0.5)' : 'none';
      });
      roadmapSteps.querySelectorAll('.step-delete').forEach((btn) => {
        btn.classList.toggle('disabled', !enabled);
      });
      toggleEditBtn.textContent = enabled ? 'Disable Editing' : 'Enable Editing';
    };

    toggleEditBtn.addEventListener('click', () => {
      editEnabled = !editEnabled;
      setEditable(editEnabled);
    });

    const createStepElement = (title, detail) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'roadmap-step';
      const card = document.createElement('div');
      card.className = 'step-card';
      card.tabIndex = 0;
      const del = document.createElement('button');
      del.className = 'step-delete' + (editEnabled ? '' : ' disabled');
      del.setAttribute('aria-label', 'Delete step');
      del.textContent = '×';
      const num = document.createElement('div');
      num.className = 'step-num';
      num.textContent = roadmapSteps.children.length + 1;
      const t = document.createElement('div');
      t.className = 'step-title';
      t.contentEditable = editEnabled ? 'true' : 'false';
      t.textContent = title;
      const d = document.createElement('div');
      d.className = 'step-detail';
      d.contentEditable = editEnabled ? 'true' : 'false';
      d.textContent = detail;
      card.appendChild(del);
      card.appendChild(num);
      card.appendChild(t);
      card.appendChild(d);
      wrapper.appendChild(card);
      attachCardInteractions(card);
      return wrapper;
    };

    // Delete step (delegated)
    const renumberSteps = () => {
      Array.from(roadmapSteps.querySelectorAll('.step-num')).forEach((numEl, idx) => {
        numEl.textContent = idx + 1;
      });
    };

    roadmapSteps.addEventListener('click', (e) => {
      const btn = e.target.closest('.step-delete');
      if (!btn || btn.classList.contains('disabled')) return;
      const card = btn.closest('.roadmap-step');
      if (card) {
        card.remove();
        renumberSteps();
      }
    });

    addStepBtn.addEventListener('click', () => {
      const count = roadmapSteps.children.length + 1;
      const el = createStepElement(`New step ${count}`, 'Describe the next investigative action.');
      roadmapSteps.appendChild(el);
      setEditable(editEnabled);
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // Map rendering (MapLibre GL + Nominatim geocode, no API key required)
    const loadScript = (src) => new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });

    const ensureMaplibre = async () => {
      if (window.maplibregl) return true;
      try {
        await loadScript('https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.js');
        return !!window.maplibregl;
      } catch (e) {
        return false;
      }
    };

    window.addEventListener('load', async () => {
      const mapContainer = document.getElementById('map');
      const hintEl = document.getElementById('map-hint');
      const locations = {{ locations | tojson }} || [];

      if (!mapContainer) return;

      const hasLib = await ensureMaplibre();
      if (!hasLib) {
        if (hintEl) hintEl.textContent = 'Map library failed to load. Check network and retry.';
        return;
      }

      try {
        const map = new maplibregl.Map({
          container: 'map',
          style: {
            version: 8,
            sources: {
              osm: {
                type: 'raster',
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '© OpenStreetMap contributors',
                maxzoom: 19,
              },
            },
            layers: [
              {
                id: 'osm',
                type: 'raster',
                source: 'osm',
              },
            ],
          },
          center: [78.9629, 20.5937],
          zoom: 4,
          maxZoom: 18,
          attributionControl: true,
        });
        map.addControl(new maplibregl.NavigationControl({ showCompass: true, showZoom: true }), 'top-right');

        const bounds = new maplibregl.LngLatBounds();

        const geocode = async (loc) => {
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc.address)}&limit=1`;
          const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
          if (!res.ok) return null;
          const data = await res.json();
          if (!data || !data.length) return null;
          const { lat, lon } = data[0];
          return { lat: parseFloat(lat), lon: parseFloat(lon) };
        };

        const addMarker = (loc, coords) => {
          new maplibregl.Marker({ color: '#5ed2ff' })
            .setLngLat([coords.lon, coords.lat])
            .setPopup(new maplibregl.Popup({ offset: 12 }).setHTML(`<strong>${loc.title}</strong><br>${loc.address}`))
            .addTo(map);
          bounds.extend([coords.lon, coords.lat]);
        };

        (async () => {
          let placed = 0;
          for (const loc of locations) {
            try {
              const coords = await geocode(loc);
              if (coords) {
                addMarker(loc, coords);
                placed += 1;
              }
            } catch (err) {
              // ignore
            }
          }
          if (placed > 0 && !bounds.isEmpty()) {
            map.fitBounds(bounds, { padding: 60, maxZoom: 15 });
            if (hintEl) hintEl.textContent = 'Showing detected locations.';
          } else {
            map.setCenter([78.9629, 20.5937]);
            map.setZoom(4);
            if (hintEl) hintEl.textContent = 'No locations plotted. Showing default view.';
          }
        })();
      } catch (err) {
        if (hintEl) hintEl.textContent = 'Map failed to initialize. Please retry.';
      }
    });

    // Chatbot functionality
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const firTextArea = document.querySelector('textarea[name="edited_text"]');

    const renderMarkdown = (value) => {
      const input = value || '';
      if (window.marked && window.DOMPurify) {
        const html = window.marked.parse(input, { breaks: true });
        return window.DOMPurify.sanitize(html);
      }
      return input
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    };

    const addMessage = (text, isUser = false) => {
      if (!chatMessages) return;
      const messageText = text || '';
      const msg = document.createElement('div');
      msg.className = `chat-message ${isUser ? 'user' : 'bot'}`;

      const sender = document.createElement('div');
      sender.className = 'sender';
      sender.textContent = isUser ? 'You' : 'AI Advisor';

      const body = document.createElement('div');
      body.className = 'text';
      if (isUser) {
        body.textContent = messageText;
      } else {
        body.innerHTML = renderMarkdown(messageText);
      }

      msg.appendChild(sender);
      msg.appendChild(body);
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const showTyping = () => {
      if (!chatMessages) return null;
      const typing = document.createElement('div');
      typing.className = 'chat-message bot typing-msg';
      const dots = document.createElement('div');
      dots.className = 'typing-indicator';
      for (let i = 0; i < 3; i += 1) {
        const dot = document.createElement('div');
        dot.className = 'typing-dot';
        dots.appendChild(dot);
      }
      typing.appendChild(dots);
      chatMessages.appendChild(typing);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return typing;
    };

    const removeTyping = () => {
      if (!chatMessages) return;
      const typing = chatMessages.querySelector('.typing-msg');
      if (typing) typing.remove();
    };

    const sendChat = async () => {
      if (!chatMessages || !chatInput || !chatSendBtn) return;
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, true);
      chatInput.value = '';
      chatSendBtn.disabled = true;

      showTyping();

      try {
        const firContext = firTextArea ? firTextArea.value : '';
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: userMessage,
            context: firContext
          })
        });

        removeTyping();

        if (res.ok) {
          const data = await res.json();
          addMessage(data.reply || 'I apologize, I could not process that request.');
        } else {
          addMessage('Sorry, there was an error processing your request. Please try again.');
        }
      } catch (err) {
        removeTyping();
        addMessage('Connection error. Please check your network and try again.');
      }

      chatSendBtn.disabled = false;
      chatInput.focus();
    };

    if (chatSendBtn && chatInput) {
      chatSendBtn.addEventListener('click', sendChat);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
      });
    }

    // Report export wiring - keep in sync with edited FIR text
    const downloadReportForm = document.getElementById('download-report-form');
    const emailReportForm = document.getElementById('email-report-form');
    const downloadReportText = document.getElementById('download-report-text');
    const emailReportText = document.getElementById('email-report-text');
    const reportEmailInput = document.getElementById('report-email-input');
    const emailToast = document.getElementById('email-toast');
    const emailToastText = document.getElementById('email-toast-text');

    const getFirText = () => (firTextArea ? firTextArea.value.trim() : '');

    if (downloadReportForm && downloadReportText) {
      downloadReportForm.addEventListener('submit', (e) => {
        const txt = getFirText();
        if (!txt) {
          e.preventDefault();
          alert('Please ensure the FIR text is present before generating a report.');
          return;
        }
        downloadReportText.value = txt;
      });
    }

    if (emailReportForm && emailReportText && reportEmailInput) {
      const showEmailToast = (state, message) => {
        if (!emailToast || !emailToastText) return;
        emailToast.classList.remove('sending', 'success', 'error');
        if (state) emailToast.classList.add(state);
        emailToastText.textContent = message;
        emailToast.classList.add('visible');
        if (state === 'success' || state === 'error') {
          setTimeout(() => {
            emailToast.classList.remove('visible');
          }, 2600);
        }
      };

      emailReportForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const txt = getFirText();
        if (!txt) {
          alert('Please ensure the FIR text is present before emailing a report.');
          return;
        }
        const email = reportEmailInput.value.trim();
        // Mirror backend: simple format check (not existence).
        const emailPattern = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
        if (!emailPattern.test(email)) {
          alert('Please enter a valid, correctly formatted email address.');
          return;
        }

        emailReportText.value = txt;

        showEmailToast('sending', 'Sending report…');
        const submitBtn = emailReportForm.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = true;

        try {
          const formData = new FormData(emailReportForm);
          const res = await fetch('/report/email', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          const data = await res.json().catch(() => ({}));

          if (res.ok && data.status === 'ok') {
            showEmailToast('success', data.message || 'Report emailed successfully.');
          } else {
            showEmailToast('error', (data && data.message) || 'Failed to send email report.');
          }
        } catch (err) {
          showEmailToast('error', 'Network error while sending report.');
        }

        if (submitBtn) submitBtn.disabled = false;
      });
    }
  </script>
</body>
</html>
