<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReviewerAI - Analysis Results</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Spline 3D Viewer -->
  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.12.27/build/spline-viewer.js"></script>
  <!-- Marked.js for markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- DOMPurify for sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; min-height: 100%; font-family: 'Space Grotesk', 'Sora', system-ui, -apple-system, sans-serif; }
    body { 
      background: radial-gradient(circle at 20% 20%, #121212, #090909 35%, #050505 70%, #000); 
      color: #ffffff; 
      overflow-x: hidden; 
      position: relative; 
    }
    body::after { 
      content: ''; 
      position: fixed; 
      inset: 0; 
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E"); 
      pointer-events: none; 
      z-index: 1; 
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

    @keyframes fadeInUp { 
      from { opacity: 0; transform: translateY(40px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    @keyframes pulse { 
      0%, 100% { opacity: 0.6; } 
      50% { opacity: 1; } 
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes scanLine {
      0% { top: 0; opacity: 1; }
      100% { top: 100%; opacity: 0.3; }
    }

    @keyframes highlightPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(138, 243, 255, 0.5), inset 0 0 10px rgba(138, 243, 255, 0.1); }
      50% { box-shadow: 0 0 25px rgba(138, 243, 255, 0.8), inset 0 0 20px rgba(138, 243, 255, 0.2); }
    }

    /* Background */
    .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; }
    .bg-orb { position: absolute; border-radius: 50%; filter: blur(80px); }
    .orb-1 { width: 420px; height: 420px; background: radial-gradient(circle, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.04)); top: -40px; left: 8%; animation: blob 8s ease-in-out infinite; }
    .orb-2 { width: 420px; height: 420px; background: radial-gradient(circle, rgba(255, 255, 255, 0.14), rgba(0, 0, 0, 0)); bottom: 5%; right: 4%; animation: blob-2 10s ease-in-out infinite; }
    .orb-3 { width: 360px; height: 360px; background: radial-gradient(circle, rgba(255, 255, 255, 0.22), rgba(0, 0, 0, 0)); top: 50%; left: 50%; transform: translate(-50%, -50%); animation: blob-3 12s ease-in-out infinite; }
    
    @keyframes blob { 0%, 100% { transform: translate(0, 0) scale(1); } 25% { transform: translate(20px, -30px) scale(1.1); } 50% { transform: translate(-20px, 20px) scale(0.95); } 75% { transform: translate(30px, 10px) scale(1.05); } }
    @keyframes blob-2 { 0%, 100% { transform: translate(0, 0) scale(1); } 25% { transform: translate(-30px, 20px) scale(0.95); } 50% { transform: translate(25px, -15px) scale(1.1); } 75% { transform: translate(-15px, -25px) scale(0.98); } }
    @keyframes blob-3 { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 25% { transform: translate(calc(-50% + 15px), calc(-50% - 20px)) scale(1.08); } 50% { transform: translate(calc(-50% - 20px), calc(-50% + 15px)) scale(0.92); } 75% { transform: translate(calc(-50% + 25px), calc(-50% + 20px)) scale(1.05); } }

    .grid-overlay { 
      position: absolute; 
      inset: 0; 
      background-image: linear-gradient(to right, rgba(255, 255, 255, 0.04) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 255, 255, 0.04) 1px, transparent 1px); 
      background-size: 4rem 4rem; 
      mask-image: radial-gradient(ellipse 60% 50% at 50% 50%, #000 70%, transparent 100%); 
    }
    .vignette { position: absolute; inset: -8%; pointer-events: none; background: radial-gradient(circle at center, transparent 52%, rgba(0, 0, 0, 0.35) 75%, rgba(0, 0, 0, 0.55) 100%); mix-blend-mode: multiply; opacity: 0.6; }

    /* Corner badge */
    .corner-badge { position: fixed; bottom: 16px; right: 16px; z-index: 9999; display: flex; align-items: center; gap: 8px; padding: 12px 18px; background: linear-gradient(135deg, rgba(12,14,18,0.96), rgba(6,8,12,0.98)); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; box-shadow: 0 10px 32px rgba(0,0,0,0.6); backdrop-filter: blur(12px); pointer-events: none; }
    .corner-badge-dot { width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, #8af3ff, #5ed2ff); box-shadow: 0 0 10px rgba(138,243,255,0.8); animation: badgePulse 2s ease-in-out infinite; }
    .corner-badge-text { font-size: 12px; font-weight: 700; letter-spacing: 1.5px; color: rgba(255,255,255,0.85); text-transform: uppercase; }
    @keyframes badgePulse { 0%, 100% { opacity: 0.6; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } }

    /* Content */
    .content { position: relative; z-index: 10; padding: 40px 0 80px; }

    /* Header */
    .header { text-align: center; margin-bottom: 32px; animation: fadeInUp 0.8s ease-out forwards; }
    .header-title { font-size: clamp(28px, 4vw, 42px); font-weight: 700; margin-bottom: 8px; background: linear-gradient(120deg, #ffffff 0%, #ffffff 50%, #ffffff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .header-subtitle { font-size: 14px; color: #ffffff; letter-spacing: 4px; text-transform: uppercase; }

    /* File info card */
    .file-info { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 24px; animation: fadeInUp 0.8s ease-out 0.1s forwards; opacity: 0; }
    .info-chip { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px; backdrop-filter: blur(10px); }
    .info-chip svg { width: 16px; height: 16px; color: #8af3ff; }
    .info-chip-label { font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
    .info-chip-value { font-size: 13px; font-weight: 600; color: #ffffff; }

    /* Score chip */
    .score-chip { background: linear-gradient(135deg, rgba(138, 243, 255, 0.1), rgba(94, 210, 255, 0.05)); border-color: rgba(138, 243, 255, 0.3); }
    .score-chip .info-chip-value { color: #8af3ff; font-size: 16px; }

    /* Main layout - Two columns */
    .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; animation: fadeInUp 0.8s ease-out 0.2s forwards; opacity: 0; }

    @media (max-width: 1024px) {
      .main-layout { grid-template-columns: 1fr; }
    }

    /* PDF Viewer Card */
    .pdf-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; backdrop-filter: blur(16px); box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset; overflow: hidden; display: flex; flex-direction: column; }
    .pdf-card-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.02); }
    .pdf-card-title { display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: 600; }
    .pdf-card-title svg { width: 20px; height: 20px; color: #8af3ff; }

    /* PDF Navigation */
    .pdf-nav { display: flex; align-items: center; gap: 12px; }
    .pdf-nav-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; color: #ffffff; }
    .pdf-nav-btn:hover:not(:disabled) { background: rgba(138, 243, 255, 0.15); border-color: rgba(138, 243, 255, 0.4); }
    .pdf-nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .pdf-nav-btn svg { width: 16px; height: 16px; }
    .pdf-page-info { font-size: 13px; color: #9ca3af; min-width: 80px; text-align: center; }
    .pdf-page-info span { color: #8af3ff; font-weight: 600; }

    /* PDF Container */
    .pdf-container { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(0, 0, 0, 0.2); min-height: 60vh; overflow: hidden; }
    .pdf-wrapper { position: relative; display: inline-block; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); border-radius: 4px; overflow: hidden; }
    #pdf-canvas { display: block; max-width: 100%; height: auto; }

    /* Highlight Overlay */
    .highlight-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .highlight-box { position: absolute; background: rgba(138, 243, 255, 0.2); border: 2px solid rgba(138, 243, 255, 0.6); border-radius: 4px; opacity: 0; transition: all 0.4s ease; }
    .highlight-box.active { opacity: 1; animation: highlightPulse 1.5s ease-in-out infinite; }

    /* Scan Line Effect */
    .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, transparent, rgba(138, 243, 255, 0.8), transparent); pointer-events: none; opacity: 0; z-index: 11; }
    .scan-line.active { animation: scanLine 1.5s ease-in-out; }

    /* Connection Line */
    .connection-line { position: fixed; pointer-events: none; z-index: 100; opacity: 0; transition: opacity 0.3s ease; }
    .connection-line.active { opacity: 1; }
    .connection-line svg { overflow: visible; }
    .connection-line path { stroke: #8af3ff; stroke-width: 2; fill: none; stroke-dasharray: 8 4; animation: dashMove 0.5s linear infinite; }
    @keyframes dashMove { to { stroke-dashoffset: -12; } }

    /* Text fallback card */
    .text-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; backdrop-filter: blur(16px); box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset; overflow: hidden; display: flex; flex-direction: column; }
    .text-card-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.02); }
    .text-card-title { display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: 600; }
    .text-card-title svg { width: 20px; height: 20px; color: #8af3ff; }
    .text-card-actions { display: flex; gap: 6px; }
    
    .text-content { padding: 20px; max-height: 55vh; overflow-y: auto; flex: 1; }
    .text-content pre { white-space: pre-wrap; word-wrap: break-word; font-family: 'Space Grotesk', monospace; font-size: 14px; line-height: 1.7; color: #e5e7eb; }

    /* Highlighted text */
    .text-content pre .highlight { background: rgba(138, 243, 255, 0.2); border-radius: 3px; padding: 2px 4px; transition: all 0.3s ease; }
    .text-content pre .highlight.active { background: rgba(138, 243, 255, 0.4); box-shadow: 0 0 20px rgba(138, 243, 255, 0.3); }

    /* Suggestions Panel */
    .suggestions-panel { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; backdrop-filter: blur(16px); box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset; overflow: hidden; display: flex; flex-direction: column; }

    .suggestions-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); background: rgba(255, 255, 255, 0.02); }
    .suggestions-title { display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: 600; }
    .suggestions-title svg { width: 20px; height: 20px; color: #8af3ff; }

    /* Page tabs */
    .page-tabs { display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.06); overflow-x: auto; flex-shrink: 0; }
    .page-tabs::-webkit-scrollbar { height: 4px; }
    .page-tabs::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    .page-tabs::-webkit-scrollbar-thumb { background: rgba(138, 243, 255, 0.3); border-radius: 2px; }

    .page-tab { padding: 8px 16px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; font-size: 13px; font-weight: 500; color: #9ca3af; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
    .page-tab:hover { background: rgba(255, 255, 255, 0.08); color: #ffffff; border-color: rgba(255, 255, 255, 0.2); }
    .page-tab.active { background: linear-gradient(135deg, rgba(138, 243, 255, 0.15), rgba(94, 210, 255, 0.1)); border-color: rgba(138, 243, 255, 0.4); color: #8af3ff; }
    .page-tab .score-badge { display: inline-block; margin-left: 8px; padding: 2px 6px; background: rgba(0, 0, 0, 0.3); border-radius: 6px; font-size: 11px; }

    /* Suggestions content */
    .suggestions-content { padding: 16px; max-height: 55vh; overflow-y: auto; flex: 1; }

    /* Overall summary */
    .overall-summary { margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(138, 243, 255, 0.06), rgba(94, 210, 255, 0.03)); border: 1px solid rgba(138, 243, 255, 0.15); border-radius: 14px; }
    .summary-grade { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
    .grade-circle { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; background: linear-gradient(135deg, #8af3ff, #5ed2ff); color: #050505; box-shadow: 0 8px 24px rgba(138, 243, 255, 0.3); }
    .grade-info h4 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .grade-info p { font-size: 13px; color: #9ca3af; }

    .summary-lists { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .summary-list { padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
    .summary-list h5 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #8af3ff; margin-bottom: 8px; }
    .summary-list ul { list-style: none; font-size: 12px; color: #d1d5db; }
    .summary-list li { padding: 4px 0; padding-left: 16px; position: relative; }
    .summary-list li::before { content: 'â†’'; position: absolute; left: 0; color: #8af3ff; }

    /* Page suggestions */
    .page-suggestions { display: none; }
    .page-suggestions.active { display: block; }

    .page-summary { font-size: 13px; color: #9ca3af; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.06); }

    /* Suggestion card */
    .suggestion-card { padding: 14px; margin-bottom: 12px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
    .suggestion-card::before { content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: #8af3ff; opacity: 0; transition: opacity 0.3s ease; }
    .suggestion-card:hover { background: rgba(255, 255, 255, 0.06); border-color: rgba(138, 243, 255, 0.3); transform: translateX(4px); }
    .suggestion-card:hover::before { opacity: 1; }
    .suggestion-card.expanded { background: rgba(138, 243, 255, 0.08); border-color: rgba(138, 243, 255, 0.4); }
    .suggestion-card.expanded::before { opacity: 1; }

    .suggestion-header { display: flex; align-items: flex-start; gap: 12px; }

    .severity-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .severity-icon svg { width: 18px; height: 18px; }
    .severity-critical { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .severity-major { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .severity-minor { background: rgba(138, 243, 255, 0.2); color: #8af3ff; }
    .severity-info { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }

    .suggestion-main { flex: 1; min-width: 0; }
    .suggestion-type { display: inline-block; padding: 3px 8px; background: rgba(255, 255, 255, 0.08); border-radius: 6px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #9ca3af; margin-bottom: 6px; }
    .suggestion-title { font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 4px; }
    .suggestion-location { font-size: 12px; color: #6b7280; }

    .suggestion-expand { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: rgba(255, 255, 255, 0.05); transition: all 0.3s ease; flex-shrink: 0; }
    .suggestion-expand svg { width: 14px; height: 14px; color: #9ca3af; transition: transform 0.3s ease; }
    .suggestion-card.expanded .suggestion-expand svg { transform: rotate(180deg); }

    .suggestion-details { display: none; margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(255, 255, 255, 0.06); }
    .suggestion-card.expanded .suggestion-details { display: block; }

    .detail-row { margin-bottom: 12px; }
    .detail-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin-bottom: 4px; }
    .detail-value { font-size: 13px; color: #d1d5db; line-height: 1.5; }
    .detail-value.affected-text { padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all; }

    /* Buttons */
    .btn { cursor: pointer; border: none; padding: 12px 24px; border-radius: 14px; font-weight: 700; font-size: 14px; transition: all 0.4s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
    .btn-primary { 
      background: linear-gradient(135deg, #ffffff, #b5b5b5 50%, #ffffff); 
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #050505; 
      box-shadow: 0 18px 50px rgba(255, 255, 255, 0.12); 
    }
    .btn-primary:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 22px 60px rgba(255, 255, 255, 0.18); }
    .btn-secondary { 
      background: rgba(255, 255, 255, 0.04); 
      border: 1px solid rgba(255, 255, 255, 0.18); 
      color: #f5f5f5; 
      backdrop-filter: blur(12px);
    }
    .btn-secondary:hover { transform: translateY(-2px) scale(1.02); border-color: rgba(255, 255, 255, 0.35); box-shadow: 0 16px 40px rgba(255, 255, 255, 0.12); }
    .btn-icon { padding: 10px; border-radius: 10px; }

    /* Actions */
    .actions { display: flex; gap: 16px; justify-content: center; margin-top: 32px; animation: fadeInUp 0.8s ease-out 0.3s forwards; opacity: 0; }

    /* Scrollbar */
    .text-content::-webkit-scrollbar, .suggestions-content::-webkit-scrollbar { width: 6px; }
    .text-content::-webkit-scrollbar-track, .suggestions-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px; }
    .text-content::-webkit-scrollbar-thumb, .suggestions-content::-webkit-scrollbar-thumb { background: rgba(138, 243, 255, 0.3); border-radius: 3px; }
    .text-content::-webkit-scrollbar-thumb:hover, .suggestions-content::-webkit-scrollbar-thumb:hover { background: rgba(138, 243, 255, 0.5); }

    /* SVG Icons */
    svg { fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    /* Loading state */
    .loading-shimmer { background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }

    .pdf-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; color: #9ca3af; }
    .pdf-loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(138, 243, 255, 0.2); border-top-color: #8af3ff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: #6b7280; }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h4 { font-size: 16px; color: #9ca3af; margin-bottom: 8px; }
    .empty-state p { font-size: 13px; }

    /* Tooltip */
    .tooltip { position: fixed; z-index: 9999; padding: 10px 14px; background: rgba(20, 20, 25, 0.98); border: 1px solid rgba(138, 243, 255, 0.3); border-radius: 10px; font-size: 13px; color: #ffffff; max-width: 300px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6); pointer-events: none; opacity: 0; transform: translateY(8px); transition: all 0.2s ease; }
    .tooltip.visible { opacity: 1; transform: translateY(0); }
    .tooltip-title { font-weight: 600; margin-bottom: 6px; color: #8af3ff; }
    .tooltip-fix { font-size: 12px; color: #9ca3af; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }

    /* Responsive */
    @media (max-width: 640px) {
      .pdf-card-header, .text-card-header, .suggestions-header { flex-direction: column; gap: 12px; align-items: flex-start; }
      .actions { flex-direction: column; }
      .actions .btn { width: 100%; justify-content: center; }
      .summary-lists { grid-template-columns: 1fr; }
    }

    /* ==================== PLAGIARISM ANALYSIS SECTION ==================== */
    
    @keyframes radarSweep {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .plagiarism-section { 
      margin-top: 32px; 
      animation: fadeInUp 0.8s ease-out 0.4s forwards; 
      opacity: 0; 
    }

    /* Main Panel - Consistent with Citations/Rewrite */
    .plagiarism-panel { 
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px; 
      backdrop-filter: blur(16px);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
      overflow: hidden;
    }

    /* Header */
    .plagiarism-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(138, 243, 255, 0.08), rgba(138, 243, 255, 0.02));
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      flex-wrap: wrap;
      gap: 16px;
    }

    .plagiarism-title { 
      display: flex; 
      align-items: center; 
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    .plagiarism-title svg { width: 24px; height: 24px; color: #8af3ff; }

    /* DNA Helix Icon */
    .plag-icon-wrap {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(138, 243, 255, 0.15);
      border-radius: 10px;
    }

    .plag-dna-helix {
      width: 24px;
      height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
    }

    .dna-strand {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dna-node {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #8af3ff;
    }

    .dna-link {
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, #8af3ff, #5ed2ff);
      margin: 0 2px;
      opacity: 0.6;
    }

    .dna-strand:nth-child(even) .dna-node { background: #5ed2ff; }

    .plag-title-text {
      display: flex;
      flex-direction: column;
    }

    .plag-title-main {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
    }

    .plag-title-sub {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Score Display - Using Circle Ring like Citations */
    .score-circle-container { 
      display: flex; 
      align-items: center; 
      gap: 20px;
    }

    .plag-score-ring {
      width: 70px;
      height: 70px;
      position: relative;
    }

    .plag-score-ring svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .plag-ring-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.1);
      stroke-width: 6;
    }

    .plag-ring-progress {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s ease-out;
    }

    .plag-ring-progress.low-risk { stroke: #10b981; }
    .plag-ring-progress.moderate-risk { stroke: #fbbf24; }
    .plag-ring-progress.elevated-risk { stroke: #f97316; }
    .plag-ring-progress.high-risk { stroke: #ef4444; }

    .plag-score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
    }

    .plag-score-text.low-risk { color: #10b981; }
    .plag-score-text.moderate-risk { color: #fbbf24; }
    .plag-score-text.elevated-risk { color: #f97316; }
    .plag-score-text.high-risk { color: #ef4444; }

    .score-info { text-align: left; }
    .score-label { 
      font-size: 11px; 
      text-transform: uppercase; 
      letter-spacing: 1px; 
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .score-value { 
      font-size: 14px; 
      font-weight: 600;
    }
    .score-value.low-risk { color: #10b981; }
    .score-value.moderate-risk { color: #fbbf24; }
    .score-value.elevated-risk { color: #f97316; }
    .score-value.high-risk { color: #ef4444; }

    /* Risk Badge - Consistent Style */
    .risk-badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px 16px; 
      border-radius: 12px; 
      font-size: 12px; 
      font-weight: 600;
    }

    .risk-badge svg { width: 16px; height: 16px; }

    .risk-badge.low { 
      background: rgba(16, 185, 129, 0.15); 
      color: #10b981; 
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .risk-badge.moderate { 
      background: rgba(251, 191, 36, 0.15); 
      color: #fbbf24; 
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .risk-badge.elevated { 
      background: rgba(249, 115, 22, 0.15); 
      color: #f97316; 
      border: 1px solid rgba(249, 115, 22, 0.3);
    }

    .risk-badge.high { 
      background: rgba(239, 68, 68, 0.15); 
      color: #ef4444; 
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Content Area */
    .plagiarism-content { 
      padding: 24px;
    }

    /* Component Scores - Grid Like Citation Stats */
    .component-scores { 
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) { .component-scores { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .component-scores { grid-template-columns: 1fr; } }

    .plag-stat-card {
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .plag-stat-card:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(138, 243, 255, 0.3);
    }

    .plag-stat-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
    }

    .plag-stat-icon svg { width: 18px; height: 18px; }
    .plag-stat-icon.cyan { background: rgba(138, 243, 255, 0.15); }
    .plag-stat-icon.cyan svg { color: #8af3ff; }
    .plag-stat-icon.green { background: rgba(16, 185, 129, 0.15); }
    .plag-stat-icon.green svg { color: #10b981; }
    .plag-stat-icon.yellow { background: rgba(251, 191, 36, 0.15); }
    .plag-stat-icon.yellow svg { color: #fbbf24; }
    .plag-stat-icon.red { background: rgba(239, 68, 68, 0.15); }
    .plag-stat-icon.red svg { color: #ef4444; }

    .plag-stat-value { 
      font-size: 24px; 
      font-weight: 700; 
      color: #ffffff; 
      margin-bottom: 4px; 
    }
    .plag-stat-value.excellent { color: #10b981; }
    .plag-stat-value.good { color: #8af3ff; }
    .plag-stat-value.moderate { color: #fbbf24; }
    .plag-stat-value.poor { color: #ef4444; }

    .plag-stat-label { 
      font-size: 11px; 
      color: #9ca3af; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
    }

    /* Radar Chart - Interactive Element */
    .radar-chart-container {
      position: relative;
      width: 160px;
      height: 160px;
      margin: 0 auto 24px;
    }

    .radar-bg {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 1px solid rgba(138, 243, 255, 0.2);
      background: rgba(138, 243, 255, 0.03);
    }

    .radar-ring {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(138, 243, 255, 0.1);
    }

    .radar-ring-1 { inset: 20%; }
    .radar-ring-2 { inset: 40%; }

    .radar-svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: auto;
    }

    .radar-axis {
      stroke: rgba(138, 243, 255, 0.12);
      stroke-width: 1;
    }

    .radar-area {
      fill: rgba(138, 243, 255, 0.18);
      transition: all 0.4s ease;
    }

    .radar-outline {
      fill: none;
      stroke: #8af3ff;
      stroke-width: 1.5;
      filter: drop-shadow(0 0 6px rgba(138, 243, 255, 0.3));
      transition: all 0.4s ease;
    }

    .radar-point {
      fill: #8af3ff;
      stroke: rgba(13, 18, 28, 0.6);
      stroke-width: 1.5;
      filter: drop-shadow(0 0 6px rgba(138, 243, 255, 0.6));
      transform-box: fill-box;
      transform-origin: center;
      transition: transform 0.2s ease, r 0.2s ease;
      cursor: pointer;
    }

    .radar-point.active {
      transform: scale(1.3);
    }

    .radar-label {
      position: absolute;
      font-size: 10px;
      color: #9ca3af;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      pointer-events: none;
      z-index: 3;
      background: rgba(17, 24, 39, 0.4);
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(8px);
    }

    .radar-tooltip {
      position: absolute;
      z-index: 4;
      opacity: 0;
      pointer-events: none;
      background: rgba(17, 24, 39, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e5e7eb;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 8px;
      transition: opacity 0.15s ease;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
    }

    .radar-tooltip.show {
      opacity: 1;
    }

    .radar-sweep {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50%;
      height: 2px;
      background: linear-gradient(90deg, rgba(138, 243, 255, 0.8), transparent);
      transform-origin: left center;
      transition: transform 0.1s ease-out;
      z-index: 5;
    }

    .radar-sweep::after {
      content: '';
      position: absolute;
      right: 0;
      top: -4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #8af3ff;
      box-shadow: 0 0 10px #8af3ff;
    }

    .radar-chart-container:not(:hover) .radar-sweep {
      animation: radarSweep 4s linear infinite;
    }

    .radar-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #8af3ff;
      box-shadow: 0 0 8px #8af3ff;
      z-index: 6;
    }

    /* Analysis tabs - Clean style */
    .analysis-tabs { 
      display: flex; 
      gap: 8px; 
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .analysis-tab { 
      padding: 10px 18px; 
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px; 
      font-size: 13px; 
      font-weight: 500; 
      color: #9ca3af;
      cursor: pointer; 
      transition: all 0.3s ease; 
      white-space: nowrap;
    }

    .analysis-tab:hover { 
      color: #ffffff;
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(138, 243, 255, 0.2);
    }
    
    .analysis-tab.active { 
      background: rgba(138, 243, 255, 0.15);
      border-color: rgba(138, 243, 255, 0.3);
      color: #8af3ff;
    }

    /* Analysis panels */
    .analysis-panel { display: none; }
    .analysis-panel.active { display: block; animation: fadeInUp 0.4s ease-out; }

    /* Issues List */
    .issues-list { margin-bottom: 24px; }

    .issue-item { 
      display: flex; 
      align-items: flex-start; 
      gap: 14px; 
      padding: 14px 16px; 
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .issue-item:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    .issue-icon { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      flex-shrink: 0; 
    }

    .issue-icon svg { width: 16px; height: 16px; }
    .issue-icon.high { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .issue-icon.medium { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .issue-icon.low { background: rgba(138, 243, 255, 0.15); color: #8af3ff; }

    .issue-content { flex: 1; }
    .issue-type { 
      font-size: 11px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .issue-message { font-size: 14px; color: #e5e7eb; line-height: 1.5; }

    /* Duplicate items */
    .duplicate-item { 
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px; 
      margin-bottom: 12px;
    }

    .duplicate-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      margin-bottom: 12px;
    }
    
    .duplicate-type { 
      font-size: 11px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      color: #8af3ff;
      font-weight: 600;
    }
    
    .duplicate-similarity { 
      font-size: 13px; 
      color: #fbbf24; 
      font-weight: 700;
      font-family: 'Space Grotesk', monospace;
    }

    .duplicate-text { 
      font-family: 'Space Grotesk', monospace;
      font-size: 12px; 
      color: #d1d5db; 
      padding: 14px; 
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      word-break: break-word;
      line-height: 1.6;
      border-left: 3px solid rgba(239, 68, 68, 0.4);
    }

    /* Vocabulary stats - Data cards */
    .vocab-stats { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 14px; 
      margin-bottom: 24px; 
    }

    @media (max-width: 700px) {
      .vocab-stats { grid-template-columns: repeat(2, 1fr); }
    }

    .vocab-stat { 
      padding: 20px 16px;
      background: linear-gradient(135deg, rgba(138, 243, 255, 0.05), transparent);
      border: 1px solid rgba(138, 243, 255, 0.1);
      border-radius: 14px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .vocab-stat::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #8af3ff, transparent);
    }

    .vocab-stat-value { 
      font-size: 24px; 
      font-weight: 700;
      font-family: 'Space Grotesk', monospace;
      color: #8af3ff;
      margin-bottom: 6px;
      text-shadow: 0 0 20px rgba(138, 243, 255, 0.3);
    }
    
    .vocab-stat-label { 
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Common phrases list */
    .phrase-list { 
      max-height: 320px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .phrase-item { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }

    .phrase-item:hover {
      border-color: rgba(138, 243, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
    }

    .phrase-text { 
      font-size: 13px;
      color: #d1d5db;
      flex: 1;
      font-style: italic;
    }
    
    .phrase-count { 
      font-size: 11px; 
      font-weight: 700;
      font-family: 'Space Grotesk', monospace;
      padding: 4px 12px; 
      border-radius: 20px; 
      background: rgba(138, 243, 255, 0.1);
      border: 1px solid rgba(138, 243, 255, 0.2);
      color: #8af3ff; 
    }

    /* Legacy component score card support */
    .component-score-card { display: none; }
    .component-icon { display: none; }
    .component-score-value { display: none; }
    .component-score-label { display: none; }

    /* Citation analysis */
    .citation-grid { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 12px; 
      margin-bottom: 20px; 
    }

    @media (max-width: 700px) {
      .citation-grid { grid-template-columns: 1fr; }
    }

    .citation-card { 
      padding: 16px; 
      background: rgba(255, 255, 255, 0.03); 
      border: 1px solid rgba(255, 255, 255, 0.08); 
      border-radius: 14px; 
    }

    .citation-card-header { font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .citation-card-value { font-size: 24px; font-weight: 700; color: #ffffff; }
    .citation-card-value.highlight { color: #8af3ff; }

    /* LLM Assessment */
    .llm-assessment { 
      padding: 16px; 
      background: linear-gradient(135deg, rgba(138, 243, 255, 0.06), rgba(94, 210, 255, 0.03)); 
      border: 1px solid rgba(138, 243, 255, 0.15); 
      border-radius: 14px; 
      margin-top: 20px; 
    }

    .llm-assessment-header { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 12px; 
      font-size: 14px; 
      font-weight: 600; 
      color: #8af3ff; 
    }

    .llm-assessment-header svg { width: 18px; height: 18px; }

    .llm-assessment-text { font-size: 14px; color: #d1d5db; line-height: 1.6; margin-bottom: 12px; }

    .llm-recommendations { list-style: none; }
    .llm-recommendations li { 
      padding: 8px 0 8px 20px; 
      position: relative; 
      font-size: 13px; 
      color: #9ca3af; 
    }
    .llm-recommendations li::before { 
      content: 'â†’'; 
      position: absolute; 
      left: 0; 
      color: #8af3ff; 
    }

    /* ==================== CITATION ANALYSIS SECTION ==================== */
    .citation-section {
      margin-top: 32px;
      animation: fadeInUp 0.8s ease-out 0.5s forwards;
      opacity: 0;
    }

    .citation-panel {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      backdrop-filter: blur(16px);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
      overflow: hidden;
    }

    .citation-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      flex-wrap: wrap;
      gap: 16px;
    }

    .citation-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    .citation-title svg { width: 24px; height: 24px; color: #fbbf24; }

    /* Citation score ring */
    .citation-score-container { display: flex; align-items: center; gap: 20px; }

    .citation-score-ring {
      width: 70px;
      height: 70px;
      position: relative;
    }

    .citation-score-ring svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .citation-ring-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.1);
      stroke-width: 6;
    }

    .citation-ring-progress {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s ease-out;
    }

    .citation-ring-progress.excellent { stroke: #10b981; }
    .citation-ring-progress.good { stroke: #8af3ff; }
    .citation-ring-progress.needs_improvement { stroke: #fbbf24; }
    .citation-ring-progress.poor { stroke: #ef4444; }

    .citation-score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
    }

    .citation-score-text.excellent { color: #10b981; }
    .citation-score-text.good { color: #8af3ff; }
    .citation-score-text.needs_improvement { color: #fbbf24; }
    .citation-score-text.poor { color: #ef4444; }

    .citation-status { text-align: left; }
    .citation-status-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #9ca3af; margin-bottom: 4px; }
    .citation-status-value { font-size: 14px; font-weight: 600; }

    /* Citation content */
    .citation-content { padding: 24px; }

    /* Citation stats grid */
    .citation-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) { .citation-stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .citation-stats-grid { grid-template-columns: 1fr; } }

    .citation-stat-card {
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .citation-stat-card:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(251, 191, 36, 0.3);
    }

    .citation-stat-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
    }

    .citation-stat-icon svg { width: 18px; height: 18px; }
    .citation-stat-icon.gold { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .citation-stat-icon.green { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .citation-stat-icon.red { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .citation-stat-icon.cyan { background: rgba(138, 243, 255, 0.15); color: #8af3ff; }

    .citation-stat-value { font-size: 24px; font-weight: 700; color: #ffffff; margin-bottom: 4px; }
    .citation-stat-label { font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Citation tabs */
    .citation-tabs {
      display: flex;
      gap: 8px;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .citation-tab {
      padding: 10px 18px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .citation-tab:hover { background: rgba(255, 255, 255, 0.08); color: #ffffff; }
    .citation-tab.active {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05));
      border-color: rgba(251, 191, 36, 0.4);
      color: #fbbf24;
    }

    /* Citation tab panels */
    .citation-tab-panel { display: none; }
    .citation-tab-panel.active { display: block; animation: fadeInUp 0.4s ease-out; }

    /* Issue cards for citations */
    .citation-issue-card {
      padding: 14px 16px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      border-left: 3px solid;
    }

    .citation-issue-card.critical { border-left-color: #ef4444; }
    .citation-issue-card.major { border-left-color: #fbbf24; }
    .citation-issue-card.minor { border-left-color: #8af3ff; }

    .citation-issue-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .citation-issue-type { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; padding: 3px 8px; border-radius: 6px; }
    .citation-issue-type.critical { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .citation-issue-type.major { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .citation-issue-type.minor { background: rgba(138, 243, 255, 0.15); color: #8af3ff; }

    .citation-issue-title { font-size: 15px; font-weight: 600; color: #ffffff; }
    .citation-issue-description { font-size: 13px; color: #9ca3af; margin-bottom: 8px; line-height: 1.5; }
    .citation-issue-recommendation { font-size: 12px; color: #8af3ff; padding: 8px 12px; background: rgba(138, 243, 255, 0.05); border-radius: 8px; }
    .citation-issue-recommendation::before { content: 'ðŸ’¡ '; }

    /* Reference list */
    .reference-list { max-height: 400px; overflow-y: auto; }

    .reference-item {
      padding: 14px 16px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .reference-item:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(255, 255, 255, 0.12); }

    .reference-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .reference-number {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .reference-verification {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .reference-verification.verified { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .reference-verification.unverified { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .reference-verification.partial { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }

    .reference-text { font-size: 13px; color: #d1d5db; line-height: 1.5; word-break: break-word; }
    .reference-meta { display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap; }
    .reference-meta-item { font-size: 11px; color: #6b7280; display: flex; align-items: center; gap: 4px; }
    .reference-meta-item svg { width: 12px; height: 12px; }

    /* Unsupported claims */
    .claim-item {
      padding: 14px 16px;
      margin-bottom: 12px;
      background: rgba(251, 191, 36, 0.05);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 10px;
    }

    .claim-type { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #fbbf24; margin-bottom: 6px; }
    .claim-context { font-size: 13px; color: #d1d5db; line-height: 1.5; }
    .claim-context mark { background: rgba(251, 191, 36, 0.3); color: #fbbf24; padding: 2px 4px; border-radius: 3px; }
    .claim-location { font-size: 11px; color: #6b7280; margin-top: 8px; }

    /* LLM Citation Assessment */
    .llm-citation-assessment {
      padding: 20px;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.08), rgba(251, 191, 36, 0.02));
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 14px;
      margin-top: 20px;
    }

    .llm-citation-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 15px;
      font-weight: 600;
      color: #fbbf24;
    }

    .llm-citation-header svg { width: 18px; height: 18px; }

    .credibility-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: auto;
    }

    .credibility-badge.high { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .credibility-badge.medium { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .credibility-badge.low { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

    /* ==================== REWRITE-TO-ACCEPT SECTION ==================== */
    .rewrite-section {
      margin-top: 32px;
      animation: fadeInUp 0.8s ease-out 0.6s forwards;
      opacity: 0;
    }

    .rewrite-panel {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      backdrop-filter: blur(16px);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
      overflow: hidden;
    }

    .rewrite-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(139, 92, 246, 0.04));
      flex-wrap: wrap;
      gap: 16px;
    }

    .rewrite-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    .rewrite-title svg { width: 24px; height: 24px; color: #a855f7; }

    .rewrite-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #a855f7;
    }

    .rewrite-badge svg { width: 16px; height: 16px; }

    .rewrite-content { padding: 24px; }

    /* Rewrite stats */
    .rewrite-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .rewrite-stats { grid-template-columns: repeat(2, 1fr); }
    }

    .rewrite-stat {
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      text-align: center;
    }

    .rewrite-stat-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }

    .rewrite-stat-icon.critical { background: rgba(239, 68, 68, 0.15); }
    .rewrite-stat-icon.critical svg { color: #ef4444; }
    .rewrite-stat-icon.high { background: rgba(249, 115, 22, 0.15); }
    .rewrite-stat-icon.high svg { color: #f97316; }
    .rewrite-stat-icon.medium { background: rgba(251, 191, 36, 0.15); }
    .rewrite-stat-icon.medium svg { color: #fbbf24; }
    .rewrite-stat-icon.ready { background: rgba(16, 185, 129, 0.15); }
    .rewrite-stat-icon.ready svg { color: #10b981; }

    .rewrite-stat-icon svg { width: 20px; height: 20px; }

    .rewrite-stat-value { font-size: 28px; font-weight: 700; color: #ffffff; margin-bottom: 4px; }
    .rewrite-stat-label { font-size: 11px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Opportunity cards */
    .rewrite-opportunities { max-height: 600px; overflow-y: auto; }

    .opportunity-card {
      padding: 18px;
      margin-bottom: 14px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .opportunity-card:hover {
      background: rgba(168, 85, 247, 0.05);
      border-color: rgba(168, 85, 247, 0.3);
      transform: translateY(-2px);
    }

    .opportunity-card.expanded {
      background: rgba(168, 85, 247, 0.08);
      border-color: rgba(168, 85, 247, 0.4);
    }

    .opportunity-header {
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }

    .opportunity-priority {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .opportunity-priority.critical { background: rgba(239, 68, 68, 0.2); }
    .opportunity-priority.critical svg { color: #ef4444; }
    .opportunity-priority.high { background: rgba(249, 115, 22, 0.2); }
    .opportunity-priority.high svg { color: #f97316; }
    .opportunity-priority.medium { background: rgba(251, 191, 36, 0.2); }
    .opportunity-priority.medium svg { color: #fbbf24; }
    .opportunity-priority.low { background: rgba(138, 243, 255, 0.2); }
    .opportunity-priority.low svg { color: #8af3ff; }

    .opportunity-priority svg { width: 18px; height: 18px; }

    .opportunity-main { flex: 1; min-width: 0; }

    .opportunity-source {
      display: inline-block;
      padding: 3px 10px;
      background: rgba(168, 85, 247, 0.15);
      border-radius: 6px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #a855f7;
      margin-bottom: 6px;
    }

    .opportunity-title { font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 4px; }
    .opportunity-description { font-size: 13px; color: #9ca3af; line-height: 1.4; }
    .opportunity-location { font-size: 11px; color: #6b7280; margin-top: 6px; }

    .opportunity-expand {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .opportunity-expand svg { width: 14px; height: 14px; color: #9ca3af; transition: transform 0.3s ease; }
    .opportunity-card.expanded .opportunity-expand svg { transform: rotate(180deg); }

    /* Rewrite details (expanded state) */
    .rewrite-details {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .opportunity-card.expanded .rewrite-details { display: block; }

    .rewrite-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 768px) {
      .rewrite-comparison { grid-template-columns: 1fr; }
    }

    .rewrite-original, .rewrite-improved {
      padding: 14px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.6;
    }

    .rewrite-original {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .rewrite-improved {
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .rewrite-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .rewrite-original .rewrite-label { color: #ef4444; }
    .rewrite-improved .rewrite-label { color: #10b981; }

    .rewrite-text { color: #d1d5db; }

    .rewrite-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 30px;
      color: #a855f7;
      font-size: 14px;
    }

    .rewrite-loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(168, 85, 247, 0.2);
      border-top-color: #a855f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .rewrite-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .rewrite-btn {
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .rewrite-btn svg { width: 16px; height: 16px; }

    .rewrite-btn-primary {
      background: linear-gradient(135deg, #a855f7, #8b5cf6);
      color: #ffffff;
    }

    .rewrite-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(168, 85, 247, 0.3); }

    .rewrite-btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #ffffff;
    }

    .rewrite-btn-secondary:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.25); }

    .rewrite-btn-success {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }

    .rewrite-btn-success:hover { background: rgba(16, 185, 129, 0.25); }

    /* Changes list */
    .changes-list {
      margin-top: 12px;
      padding: 12px;
      background: rgba(168, 85, 247, 0.06);
      border-radius: 10px;
    }

    .changes-list-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #a855f7; margin-bottom: 8px; }
    .changes-list ul { list-style: none; }
    .changes-list li {
      padding: 6px 0 6px 18px;
      position: relative;
      font-size: 12px;
      color: #9ca3af;
    }
    .changes-list li::before { content: 'âœ“'; position: absolute; left: 0; color: #10b981; }

    /* Section rewrite cards */
    .section-rewrites {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .section-rewrites-title {
      font-size: 16px;
      font-weight: 600;
      color: #a855f7;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-rewrites-title svg { width: 20px; height: 20px; }

    .section-card {
      padding: 16px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .section-card:hover { background: rgba(255, 255, 255, 0.04); }

    .section-info { flex: 1; }
    .section-name { font-size: 14px; font-weight: 600; color: #ffffff; text-transform: capitalize; margin-bottom: 4px; }
    .section-preview { font-size: 12px; color: #6b7280; }

    /* ==================== ANALYSIS TABS (Top-level) ==================== */
    .analysis-tabs-container {
      margin-top: 32px;
      animation: fadeInUp 0.8s ease-out 0.3s forwards;
      opacity: 0;
    }

    .analysis-tabs-nav {
      display: flex;
      gap: 8px;
      padding: 6px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .analysis-tab-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 24px;
      background: transparent;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      position: relative;
    }

    .analysis-tab-btn svg {
      width: 18px;
      height: 18px;
      opacity: 0.7;
      transition: all 0.3s ease;
    }

    .analysis-tab-btn:hover {
      color: #ffffff;
      background: rgba(255, 255, 255, 0.05);
    }

    .analysis-tab-btn:hover svg {
      opacity: 1;
    }

    .analysis-tab-btn.active {
      background: linear-gradient(135deg, rgba(138, 243, 255, 0.15), rgba(94, 210, 255, 0.08));
      color: #8af3ff;
      box-shadow: 0 0 20px rgba(138, 243, 255, 0.1);
    }

    .analysis-tab-btn.active svg {
      opacity: 1;
      color: #8af3ff;
    }

    .analysis-tab-btn.active.plagiarism-tab {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.08));
      color: #10b981;
    }

    .analysis-tab-btn.active.plagiarism-tab svg {
      color: #10b981;
    }

    .analysis-tab-btn.active.citation-tab {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.08));
      color: #fbbf24;
    }

    .analysis-tab-btn.active.citation-tab svg {
      color: #fbbf24;
    }

    .analysis-tab-btn.active.rewrite-tab {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.08));
      color: #a855f7;
    }

    .analysis-tab-btn.active.rewrite-tab svg {
      color: #a855f7;
    }

    .tab-badge {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: inherit;
    }

    .analysis-tab-btn.active .tab-badge {
      background: rgba(255, 255, 255, 0.2);
    }

    .analysis-tab-content {
      display: none;
    }

    .analysis-tab-content.active {
      display: block;
      animation: fadeInUp 0.4s ease-out forwards;
    }

    /* Hide individual section wrappers when inside tabs */
    .analysis-tabs-container .plagiarism-section,
    .analysis-tabs-container .citation-section,
    .analysis-tabs-container .rewrite-section {
      margin-top: 0;
    }

    @media (max-width: 768px) {
      .analysis-tabs-nav {
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 4px;
      }

      .analysis-tab-btn {
        padding: 12px 16px;
        font-size: 13px;
      }

      .analysis-tab-btn svg {
        width: 16px;
        height: 16px;
      }
    }

    /* Modal Styles */
    .rewrite-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .rewrite-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
    }

    .modal-container {
      position: relative;
      background: #0a0a0a;
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 20px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(168, 85, 247, 0.2), 0 0 100px rgba(168, 85, 247, 0.1);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .rewrite-modal.active .modal-container {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(180deg, rgba(168, 85, 247, 0.1) 0%, transparent 100%);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #a855f7;
      margin: 0;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #9ca3af;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .modal-body {
      padding: 24px;
      max-height: calc(85vh - 80px);
      overflow-y: auto;
    }

    .modal-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .loading-spinner-large {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(168, 85, 247, 0.2);
      border-top-color: #a855f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .highlight-phrase {
      background: rgba(168, 85, 247, 0.2);
      color: #c084fc;
      padding: 1px 4px;
      border-radius: 3px;
    }

    .rewrite-error {
      text-align: center;
      padding: 20px;
      color: #ef4444;
    }

    .rewrite-error .error-icon {
      font-size: 24px;
      margin-right: 8px;
    }

    .loading-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 6px;
    }

    .rewrite-btn.copied, .rewrite-btn.applied {
      background: rgba(16, 185, 129, 0.2) !important;
      border-color: rgba(16, 185, 129, 0.4) !important;
      color: #10b981 !important;
    }

    .opportunity-card.rewrite-applied {
      opacity: 0.7;
      border-color: rgba(16, 185, 129, 0.3);
    }

    .opportunity-card.rewrite-applied::after {
      content: 'âœ“ Applied';
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ==================== CHATBOT SECTION ==================== */
    .chatbot-wrapper { 
      margin: 48px 0 32px; 
      animation: fadeInUp 0.8s ease-out 0.6s forwards; 
      opacity: 0; 
    }

    .chatbot-section-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .chatbot-pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 10px 16px;
      background: rgba(138, 243, 255, 0.08);
      border: 1px solid rgba(138, 243, 255, 0.25);
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: #8af3ff;
      margin-bottom: 14px;
    }

    .chatbot-pill .status-dots {
      display: flex;
      gap: 4px;
    }

    .chatbot-pill .status-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #8af3ff;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .chatbot-pill .status-dots span:nth-child(2) { animation-delay: 0.2s; }
    .chatbot-pill .status-dots span:nth-child(3) { animation-delay: 0.4s; }

    .chatbot-section-title {
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
      letter-spacing: -0.2px;
      margin-bottom: 8px;
    }

    .chatbot-section-sub {
      color: #9ca3af;
      font-size: 15px;
    }

    .chat-shell {
      padding: 20px;
      border-radius: 22px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(16px);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
    }

    .chatbot-container {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 20px;
      align-items: stretch;
    }

    @media (max-width: 900px) {
      .chatbot-container { grid-template-columns: 1fr; }
      .chat-panel { height: 480px; }
    }

    .chatbot-robot {
      border-radius: 18px;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, rgba(138, 243, 255, 0.12), transparent 55%), rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.08);
      min-height: 440px;
      position: relative;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.55);
    }

    .chatbot-robot spline-viewer {
      width: 100%;
      height: calc(100% + 50px);
      min-height: 490px;
      display: block;
      position: relative;
      top: 0;
      margin-bottom: -50px;
    }

    .chat-panel {
      display: flex;
      flex-direction: column;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      overflow: hidden;
      min-height: 440px;
      height: 500px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-height: 340px;
    }

    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(138, 243, 255, 0.3); border-radius: 3px; }

    .chat-message {
      padding: 14px 18px;
      border-radius: 16px;
      max-width: 88%;
      animation: fadeInUp 0.3s ease;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.06);
      text-align: left;
    }

    .chat-message.bot {
      background: linear-gradient(135deg, rgba(138, 243, 255, 0.18), rgba(110, 212, 255, 0.1));
      border-color: rgba(138, 243, 255, 0.3);
      align-self: flex-start;
    }

    .chat-message.user {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.12);
      align-self: flex-end;
    }

    .chat-message .sender {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #8af3ff;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .chat-message.user .sender { color: #9ca3af; }

    .chat-message .text {
      font-size: 14px;
      line-height: 1.65;
      color: #f0f8ff;
      word-break: break-word;
    }

    .chat-message .text p { margin: 6px 0; }
    .chat-message .text ul, .chat-message .text ol { margin: 8px 0 8px 0; padding-left: 20px; }
    .chat-message .text li { margin: 4px 0; }
    .chat-message .text code { background: rgba(0, 0, 0, 0.3); padding: 2px 6px; border-radius: 4px; font-size: 13px; color: #8af3ff; }
    .chat-message .text strong { color: #ffffff; }

    .chat-input-area {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.2);
    }

    .chat-input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.35);
      color: #ffffff;
      font-size: 14px;
      font-family: 'Space Grotesk', system-ui, sans-serif;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .chat-input:focus {
      border-color: rgba(138, 243, 255, 0.5);
      box-shadow: 0 0 0 3px rgba(138, 243, 255, 0.15);
    }

    .chat-input::placeholder { color: #6b7280; }

    .chat-send-btn {
      padding: 14px 24px;
      border-radius: 14px;
      border: 1px solid rgba(138, 243, 255, 0.3);
      background: linear-gradient(135deg, rgba(138, 243, 255, 0.2), rgba(94, 210, 255, 0.15));
      color: #8af3ff;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .chat-send-btn:hover {
      background: linear-gradient(135deg, rgba(138, 243, 255, 0.3), rgba(94, 210, 255, 0.25));
      border-color: rgba(138, 243, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(138, 243, 255, 0.2);
    }

    .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .chat-disclaimer {
      padding: 12px 20px;
      font-size: 12px;
      color: #9ca3af;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(0, 0, 0, 0.15);
    }

    .chat-disclaimer strong { color: #fbbf24; }

    .typing-indicator {
      display: flex;
      gap: 6px;
      padding: 4px 0;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #8af3ff;
      animation: typingBounce 1.2s ease-in-out infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-8px); opacity: 1; }
    }

  </style>
</head>
<body>
  <div class="background">
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="bg-orb orb-3"></div>
    <div class="grid-overlay"></div>
    <div class="vignette"></div>
  </div>

  <div class="corner-badge">
    <div class="corner-badge-dot"></div>
    <span class="corner-badge-text">ReviewerAI</span>
  </div>

  <!-- Tooltip container -->
  <div id="tooltip" class="tooltip">
    <div class="tooltip-title"></div>
    <div class="tooltip-desc"></div>
    <div class="tooltip-fix"></div>
  </div>

  <!-- Connection line for mapping animation -->
  <div id="connection-line" class="connection-line">
    <svg width="100%" height="100%">
      <path id="connection-path" d="" />
    </svg>
  </div>

  <div class="content">
    <div class="container">
      <div class="header">
        <h1 class="header-title">Analysis Results</h1>
        <p class="header-subtitle">Research Paper Review</p>
      </div>

      <div class="file-info">
        <div class="info-chip">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
          <div>
            <div class="info-chip-label">File</div>
            <div class="info-chip-value">{{ filename }}</div>
          </div>
        </div>
        <div class="info-chip">
          <svg viewBox="0 0 24 24"><path d="M4 7V4h16v3"></path><path d="M9 20h6"></path><path d="M12 4v16"></path></svg>
          <div>
            <div class="info-chip-label">Words</div>
            <div class="info-chip-value">{{ word_count | default(0) }}</div>
          </div>
        </div>
        <div class="info-chip">
          <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
          <div>
            <div class="info-chip-label">Characters</div>
            <div class="info-chip-value">{{ char_count | default(0) }}</div>
          </div>
        </div>
        {% if formatting_data and formatting_data.score %}
        <div class="info-chip score-chip">
          <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
          <div>
            <div class="info-chip-label">Format Score</div>
            <div class="info-chip-value">{{ formatting_data.score }}/100</div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="main-layout">
        <!-- PDF Viewer Column -->
        {% if is_pdf and pdf_base64 %}
        <div class="pdf-card" id="pdf-card">
          <div class="pdf-card-header">
            <div class="pdf-card-title">
              <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              Document Preview
            </div>
            <div class="pdf-nav">
              <button class="pdf-nav-btn" id="prev-page" disabled title="Previous Page">
                <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
              </button>
              <div class="pdf-page-info">
                Page <span id="current-page">1</span> of <span id="total-pages">-</span>
              </div>
              <button class="pdf-nav-btn" id="next-page" title="Next Page">
                <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
              </button>
            </div>
          </div>
          <div class="pdf-container" id="pdf-container">
            <div class="pdf-loading" id="pdf-loading">
              <div class="pdf-loading-spinner"></div>
              <span>Loading PDF...</span>
            </div>
            <div class="pdf-wrapper" id="pdf-wrapper" style="display: none;">
              <canvas id="pdf-canvas"></canvas>
              <div class="highlight-overlay" id="highlight-overlay"></div>
              <div class="scan-line" id="scan-line"></div>
            </div>
          </div>
        </div>
        {% else %}
        <!-- Text fallback for non-PDF files -->
        <div class="text-card">
          <div class="text-card-header">
            <div class="text-card-title">
              <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
              Extracted Text
            </div>
            <div class="text-card-actions">
              <button class="btn btn-secondary btn-icon" onclick="copyText()" title="Copy to clipboard">
                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
              </button>
              <button class="btn btn-secondary btn-icon" onclick="downloadText()" title="Download text">
                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              </button>
            </div>
          </div>
          <div class="text-content">
            <pre id="extracted-text">{{ extracted_text }}</pre>
          </div>
        </div>
        {% endif %}

        <!-- Formatting Suggestions Column -->
        <div class="suggestions-panel" id="suggestions-panel">
          <div class="suggestions-header">
            <div class="suggestions-title">
              <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
              Formatting Suggestions
            </div>
          </div>

          {% if formatting_data and formatting_data.pages %}
          <!-- Page tabs -->
          <div class="page-tabs" id="page-tabs">
            <button class="page-tab active" data-page="overall">
              Overview
            </button>
            {% for page in formatting_data.pages %}
            <button class="page-tab" data-page="{{ page.page_number }}">
              Page {{ page.page_number }}
              <span class="score-badge">{{ page.page_score }}</span>
            </button>
            {% endfor %}
          </div>

          <div class="suggestions-content">
            <!-- Overall Summary -->
            <div class="page-suggestions active" data-page="overall">
              {% if formatting_data.overall %}
              <div class="overall-summary">
                <div class="summary-grade">
                  <div class="grade-circle">{{ formatting_data.overall.grade | default('B') }}</div>
                  <div class="grade-info">
                    <h4>Document Quality Score: {{ formatting_data.score }}/100</h4>
                    <p>{{ formatting_data.total_pages }} page(s) analyzed</p>
                  </div>
                </div>
                <div class="summary-lists">
                  {% if formatting_data.overall.strengths %}
                  <div class="summary-list">
                    <h5>Strengths</h5>
                    <ul>
                      {% for strength in formatting_data.overall.strengths[:3] %}
                      <li>{{ strength }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                  {% if formatting_data.overall.improvements_needed %}
                  <div class="summary-list">
                    <h5>Needs Improvement</h5>
                    <ul>
                      {% for improvement in formatting_data.overall.improvements_needed[:3] %}
                      <li>{{ improvement }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              {% if formatting_data.overall and formatting_data.overall.suggestions %}
              {% for suggestion in formatting_data.overall.suggestions %}
              <div class="suggestion-card" 
                   data-title="{{ suggestion.title }}"
                   data-description="{{ suggestion.description | default('') }}"
                   data-fix=""
                   data-page="0">
                <div class="suggestion-header">
                  <div class="severity-icon severity-{{ suggestion.priority | default('medium') | replace('high', 'major') | replace('medium', 'minor') | replace('low', 'info') }}">
                    <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path></svg>
                  </div>
                  <div class="suggestion-main">
                    <span class="suggestion-type">{{ suggestion.type | default('structure') }}</span>
                    <div class="suggestion-title">{{ suggestion.title }}</div>
                  </div>
                  <div class="suggestion-expand">
                    <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  </div>
                </div>
                <div class="suggestion-details">
                  <div class="detail-row">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">{{ suggestion.description | default('No additional details available.') }}</div>
                  </div>
                </div>
              </div>
              {% endfor %}
              {% endif %}
            </div>

            <!-- Per-page suggestions -->
            {% for page in formatting_data.pages %}
            <div class="page-suggestions" data-page="{{ page.page_number }}">
              <div class="page-summary">{{ page.summary | default('Page ' ~ page.page_number ~ ' analysis') }}</div>
              
              {% if page.suggestions %}
              {% for suggestion in page.suggestions %}
              <div class="suggestion-card" 
                   data-title="{{ suggestion.title }}"
                   data-description="{{ suggestion.description | default('') }}"
                   data-fix="{{ suggestion.fix | default('') }}"
                   data-affected="{{ suggestion.affected_text | default('') }}"
                   data-page="{{ page.page_number }}"
                   data-location-y="{{ suggestion.location_y | default(0.3) }}"
                   data-location-x="{{ suggestion.location_x | default(0.5) }}"
                   data-location-width="{{ suggestion.location_width | default(0.4) }}"
                   data-location-height="{{ suggestion.location_height | default(0.05) }}">
                <div class="suggestion-header">
                  <div class="severity-icon severity-{{ suggestion.severity | default('info') }}">
                    {% if suggestion.severity == 'critical' %}
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    {% elif suggestion.severity == 'major' %}
                    <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    {% elif suggestion.severity == 'minor' %}
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                    {% else %}
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    {% endif %}
                  </div>
                  <div class="suggestion-main">
                    <span class="suggestion-type">{{ suggestion.type | default('general') }}</span>
                    <div class="suggestion-title">{{ suggestion.title }}</div>
                    <div class="suggestion-location">{{ suggestion.location | default('') }}</div>
                  </div>
                  <div class="suggestion-expand">
                    <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  </div>
                </div>
                <div class="suggestion-details">
                  <div class="detail-row">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">{{ suggestion.description }}</div>
                  </div>
                  {% if suggestion.fix %}
                  <div class="detail-row">
                    <div class="detail-label">Suggested Fix</div>
                    <div class="detail-value">{{ suggestion.fix }}</div>
                  </div>
                  {% endif %}
                  {% if suggestion.affected_text %}
                  <div class="detail-row">
                    <div class="detail-label">Affected Text</div>
                    <div class="detail-value affected-text">{{ suggestion.affected_text }}</div>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <h4>Looking Good!</h4>
                <p>No significant formatting issues detected on this page.</p>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="suggestions-content">
            <div class="empty-state">
              <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
              <h4>Analysis Unavailable</h4>
              <p>Could not generate formatting suggestions for this document.</p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- ==================== ANALYSIS TABS CONTAINER ==================== -->
      {% if plagiarism_data or citation_data or (rewrite_data and rewrite_data.opportunities) %}
      <div class="analysis-tabs-container">
        <div class="analysis-tabs-nav" id="analysis-tabs-nav">
          {% if plagiarism_data %}
          <button class="analysis-tab-btn plagiarism-tab active" data-tab="plagiarism">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path>
              <rect x="9" y="3" width="6" height="4" rx="1"></rect>
              <path d="M9 12h6"></path><path d="M9 16h6"></path>
            </svg>
            Plagiarism
            <span class="tab-badge">{{ plagiarism_data.overall_score | default(0) | round | int }}%</span>
          </button>
          {% endif %}
          {% if citation_data %}
          <button class="analysis-tab-btn citation-tab {% if not plagiarism_data %}active{% endif %}" data-tab="citation">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 2h9a2 2 0 0 1 2 2v2"></path>
              <path d="M6 22h12a2 2 0 0 0 2-2V9.5L14.5 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <path d="M12 18v-6"></path><path d="M9 15l3 3 3-3"></path>
            </svg>
            Citations
            <span class="tab-badge">{{ citation_data.citation_score | default(0) | round | int }}</span>
          </button>
          {% endif %}
          {% if rewrite_data and rewrite_data.opportunities %}
          <button class="analysis-tab-btn rewrite-tab {% if not plagiarism_data and not citation_data %}active{% endif %}" data-tab="rewrite">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Rewrite
            <span class="tab-badge">{{ rewrite_data.stats.rewrite_ready_count | default(0) }}</span>
          </button>
          {% endif %}
        </div>

        <!-- Plagiarism Tab Content -->
        {% if plagiarism_data %}
        <div class="analysis-tab-content active" data-tab="plagiarism">
          <div class="plagiarism-section">
            <div class="plagiarism-panel">
              <div class="plagiarism-header">
                <div class="plagiarism-title">
                  <div class="plag-icon-wrap">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; color: #8af3ff;"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2" fill="none" stroke="currentColor" stroke-width="2"></path><rect x="9" y="3" width="6" height="4" rx="1" fill="none" stroke="currentColor" stroke-width="2"></rect><path d="M9 12h6M9 16h6" fill="none" stroke="currentColor" stroke-width="2"></path></svg>
                  </div>
                  <span class="plag-title-main">Plagiarism Analysis</span>
                </div>
                <div class="score-circle-container">
                  <div class="plag-score-ring">
                    <svg viewBox="0 0 36 36">
                      <circle class="plag-ring-bg" cx="18" cy="18" r="15"></circle>
                      <circle class="plag-ring-progress {% if plagiarism_data.overall_score >= 85 %}low-risk{% elif plagiarism_data.overall_score >= 70 %}moderate-risk{% elif plagiarism_data.overall_score >= 50 %}elevated-risk{% else %}high-risk{% endif %}" 
                              cx="18" cy="18" r="15"
                              stroke-dasharray="{{ ((plagiarism_data.overall_score) / 100) * 94.2 }} 94.2"></circle>
                    </svg>
                    <span class="plag-score-text {% if plagiarism_data.overall_score >= 85 %}low-risk{% elif plagiarism_data.overall_score >= 70 %}moderate-risk{% elif plagiarism_data.overall_score >= 50 %}elevated-risk{% else %}high-risk{% endif %}">{{ plagiarism_data.overall_score | round | int }}</span>
                  </div>
                  <div class="score-info">
                    <div class="score-label">Originality Score</div>
                    <div class="score-value {% if plagiarism_data.overall_score >= 85 %}low-risk{% elif plagiarism_data.overall_score >= 70 %}moderate-risk{% elif plagiarism_data.overall_score >= 50 %}elevated-risk{% else %}high-risk{% endif %}">
                      {{ plagiarism_data.overall_score | round(1) }}/100
                    </div>
                  </div>
                  <div class="risk-badge {{ plagiarism_data.risk_level }}">
                    {% if plagiarism_data.risk_level == 'low' %}
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" fill="none" stroke="currentColor" stroke-width="2"></path><polyline points="22 4 12 14.01 9 11.01" fill="none" stroke="currentColor" stroke-width="2"></polyline></svg>
                    {% elif plagiarism_data.risk_level == 'moderate' %}
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"></circle><line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2"></line><line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2"></line></svg>
                    {% else %}
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"></circle><line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"></line><line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"></line></svg>
                    {% endif %}
                    {{ plagiarism_data.risk_level | capitalize }} Risk
                  </div>
                </div>
              </div>

              <div class="plagiarism-content">
                <!-- Component Scores Grid -->
                {% if plagiarism_data.component_scores %}
                <div class="component-scores">
                  <div class="plag-stat-card">
                    <div class="plag-stat-icon {% if plagiarism_data.component_scores.duplicate_check >= 85 %}green{% elif plagiarism_data.component_scores.duplicate_check >= 70 %}cyan{% elif plagiarism_data.component_scores.duplicate_check >= 50 %}yellow{% else %}red{% endif %}">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </div>
                    <div class="plag-stat-value {% if plagiarism_data.component_scores.duplicate_check >= 85 %}excellent{% elif plagiarism_data.component_scores.duplicate_check >= 70 %}good{% elif plagiarism_data.component_scores.duplicate_check >= 50 %}moderate{% else %}poor{% endif %}">{{ plagiarism_data.component_scores.duplicate_check }}%</div>
                    <div class="plag-stat-label">Duplicates</div>
                  </div>
                  <div class="plag-stat-card">
                    <div class="plag-stat-icon {% if plagiarism_data.component_scores.vocabulary_richness >= 70 %}green{% elif plagiarism_data.component_scores.vocabulary_richness >= 50 %}cyan{% elif plagiarism_data.component_scores.vocabulary_richness >= 35 %}yellow{% else %}red{% endif %}">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    </div>
                    <div class="plag-stat-value {% if plagiarism_data.component_scores.vocabulary_richness >= 70 %}excellent{% elif plagiarism_data.component_scores.vocabulary_richness >= 50 %}good{% elif plagiarism_data.component_scores.vocabulary_richness >= 35 %}moderate{% else %}poor{% endif %}">{{ plagiarism_data.component_scores.vocabulary_richness }}%</div>
                    <div class="plag-stat-label">Vocabulary</div>
                  </div>
                  <div class="plag-stat-card">
                    <div class="plag-stat-icon {% if plagiarism_data.component_scores.phrase_originality >= 85 %}green{% elif plagiarism_data.component_scores.phrase_originality >= 70 %}cyan{% elif plagiarism_data.component_scores.phrase_originality >= 50 %}yellow{% else %}red{% endif %}">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
                    </div>
                    <div class="plag-stat-value {% if plagiarism_data.component_scores.phrase_originality >= 85 %}excellent{% elif plagiarism_data.component_scores.phrase_originality >= 70 %}good{% elif plagiarism_data.component_scores.phrase_originality >= 50 %}moderate{% else %}poor{% endif %}">{{ plagiarism_data.component_scores.phrase_originality }}%</div>
                    <div class="plag-stat-label">Originality</div>
                  </div>
                  <div class="plag-stat-card">
                    <div class="plag-stat-icon {% if plagiarism_data.component_scores.style_consistency >= 80 %}green{% elif plagiarism_data.component_scores.style_consistency >= 60 %}cyan{% elif plagiarism_data.component_scores.style_consistency >= 40 %}yellow{% else %}red{% endif %}">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </div>
                    <div class="plag-stat-value {% if plagiarism_data.component_scores.style_consistency >= 80 %}excellent{% elif plagiarism_data.component_scores.style_consistency >= 60 %}good{% elif plagiarism_data.component_scores.style_consistency >= 40 %}moderate{% else %}poor{% endif %}">{{ plagiarism_data.component_scores.style_consistency }}%</div>
                    <div class="plag-stat-label">Style</div>
                  </div>
                </div>

                <!-- Radar Chart - Interactive -->
                <div class="radar-chart-container"
                     data-duplicates="{{ plagiarism_data.component_scores.duplicate_check | default(0) }}"
                     data-vocabulary="{{ plagiarism_data.component_scores.vocabulary_richness | default(0) }}"
                     data-originality="{{ plagiarism_data.component_scores.phrase_originality | default(0) }}"
                     data-style="{{ plagiarism_data.component_scores.style_consistency | default(0) }}">
                  <div class="radar-bg"></div>
                  <div class="radar-ring radar-ring-1"></div>
                  <div class="radar-ring radar-ring-2"></div>
                  <svg class="radar-svg" viewBox="0 0 200 200" aria-hidden="true">
                    <line class="radar-axis" x1="100" y1="100" x2="100" y2="20"></line>
                    <line class="radar-axis" x1="100" y1="100" x2="180" y2="100"></line>
                    <line class="radar-axis" x1="100" y1="100" x2="100" y2="180"></line>
                    <line class="radar-axis" x1="100" y1="100" x2="20" y2="100"></line>
                    <polygon class="radar-area" points=""></polygon>
                    <polygon class="radar-outline" points=""></polygon>
                    <g class="radar-points">
                      <circle class="radar-point" data-axis="duplicates" r="4"></circle>
                      <circle class="radar-point" data-axis="vocabulary" r="4"></circle>
                      <circle class="radar-point" data-axis="originality" r="4"></circle>
                      <circle class="radar-point" data-axis="style" r="4"></circle>
                    </g>
                  </svg>
                  <div class="radar-label" data-axis="duplicates">Duplicates</div>
                  <div class="radar-label" data-axis="vocabulary">Vocabulary</div>
                  <div class="radar-label" data-axis="originality">Originality</div>
                  <div class="radar-label" data-axis="style">Style</div>
                  <div class="radar-tooltip" aria-hidden="true"></div>
                  <div class="radar-sweep"></div>
                  <div class="radar-center"></div>
                </div>
                {% endif %}

                <!-- Issues -->
                {% if plagiarism_data.issues %}
                <div class="issues-list">
                  <h4 style="font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 12px;">Detected Issues</h4>
                  {% for issue in plagiarism_data.issues %}
                  <div class="issue-item">
                    <div class="issue-icon {{ issue.severity }}">
                      {% if issue.severity == 'high' %}
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                      {% elif issue.severity == 'medium' %}
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                      {% else %}
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                      {% endif %}
                    </div>
                    <div class="issue-content">
                      <div class="issue-type">{{ issue.type | replace('_', ' ') }}</div>
                      <div class="issue-message">{{ issue.message }}</div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% endif %}

                <!-- Analysis Tabs -->
                <div class="analysis-tabs" id="plagiarism-tabs">
                  <button class="analysis-tab active" data-panel="duplicates">Duplicates</button>
                  <button class="analysis-tab" data-panel="vocabulary">Vocabulary</button>
                  <button class="analysis-tab" data-panel="phrases">Common Phrases</button>
                  <button class="analysis-tab" data-panel="style">Style Analysis</button>
                </div>

                <!-- Duplicates Panel -->
                <div class="analysis-panel active" data-panel="duplicates">
                  {% if plagiarism_data.analyses and plagiarism_data.analyses.internal_duplicates %}
                  {% set dups = plagiarism_data.analyses.internal_duplicates %}
                  <p style="font-size: 14px; color: #9ca3af; margin-bottom: 16px;">
                    Found <strong style="color: #8af3ff;">{{ dups.duplicate_count }}</strong> internal duplicate(s) 
                    (<span style="color: {% if dups.duplicate_percentage > 10 %}#ef4444{% elif dups.duplicate_percentage > 5 %}#fbbf24{% else %}#10b981{% endif %};">{{ dups.duplicate_percentage }}%</span> of content)
                  </p>
                  {% if dups.duplicates %}
                  {% for dup in dups.duplicates[:5] %}
                  <div class="duplicate-item">
                    <div class="duplicate-header">
                      <span class="duplicate-type">{{ dup.type | replace('_', ' ') | title }}</span>
                      {% if dup.similarity %}
                      <span class="duplicate-similarity" style="color: #fbbf24;">{{ dup.similarity }}% similar</span>
                      {% endif %}
                    </div>
                    <div class="duplicate-text" style="font-size: 13px; color: #e5e7eb; line-height: 1.6; padding-left: 12px; border-left: 2px solid rgba(138, 243, 255, 0.3);">"{{ dup.text }}"</div>
                    {% if dup.similar_to %}
                    <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">Similar to:</div>
                    <div class="duplicate-text" style="margin-top: 4px; opacity: 0.7; font-size: 13px; color: #e5e7eb; line-height: 1.6; padding-left: 12px; border-left: 2px solid rgba(239, 68, 68, 0.3);">"{{ dup.similar_to }}"</div>
                    {% endif %}
                  </div>
                  {% endfor %}
                  {% else %}
                  <div class="empty-state" style="padding: 24px; background: rgba(255, 255, 255, 0.02); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.06); text-align: center;">
                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; stroke: #10b981; fill: none; stroke-width: 2;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <h4 style="color: #10b981; margin-top: 12px; font-size: 14px;">No Duplicates Found</h4>
                    <p style="color: #9ca3af; font-size: 13px;">Great! No significant internal duplicate content detected.</p>
                  </div>
                  {% endif %}
              {% endif %}
            </div>

            <!-- Vocabulary Panel -->
            <div class="analysis-panel" data-panel="vocabulary">
              {% if plagiarism_data.analyses and plagiarism_data.analyses.vocabulary %}
              {% set vocab = plagiarism_data.analyses.vocabulary %}
              <div class="vocab-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
                <div class="vocab-stat" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 16px; text-align: center;">
                  <div class="vocab-stat-value" style="font-size: 24px; font-weight: 700; color: #8af3ff;">{{ vocab.total_words | default(0) }}</div>
                  <div class="vocab-stat-label" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #9ca3af; margin-top: 4px;">Total Words</div>
                </div>
                <div class="vocab-stat" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 16px; text-align: center;">
                  <div class="vocab-stat-value" style="font-size: 24px; font-weight: 700; color: #10b981;">{{ vocab.unique_words | default(0) }}</div>
                  <div class="vocab-stat-label" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #9ca3af; margin-top: 4px;">Unique Words</div>
                </div>
                <div class="vocab-stat" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 16px; text-align: center;">
                  <div class="vocab-stat-value" style="font-size: 24px; font-weight: 700; color: #fbbf24;">{{ vocab.vocabulary_richness | default(0) }}%</div>
                  <div class="vocab-stat-label" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #9ca3af; margin-top: 4px;">Type-Token Ratio</div>
                </div>
                <div class="vocab-stat" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 16px; text-align: center;">
                  <div class="vocab-stat-value" style="font-size: 24px; font-weight: 700; color: #a855f7;">{{ vocab.hapax_legomena | default(0) }}</div>
                  <div class="vocab-stat-label" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #9ca3af; margin-top: 4px;">Hapax Legomena</div>
                </div>
              </div>
              <p style="font-size: 13px; color: #9ca3af;">
                <strong>Assessment:</strong> <span style="color: {% if vocab.assessment == 'excellent' %}#10b981{% elif vocab.assessment == 'good' %}#8af3ff{% elif vocab.assessment == 'moderate' %}#fbbf24{% else %}#ef4444{% endif %};">{{ vocab.assessment | default('N/A') | title }}</span>
                {% if vocab.assessment == 'excellent' %} â€” Excellent vocabulary diversity indicates original writing.
                {% elif vocab.assessment == 'good' %} â€” Good vocabulary range suggests authentic content.
                {% elif vocab.assessment == 'moderate' %} â€” Moderate diversity; consider varying word choice.
                {% else %} â€” Low vocabulary diversity may indicate copied or templated content.{% endif %}
              </p>
              {% endif %}
            </div>

            <!-- Common Phrases Panel -->
            <div class="analysis-panel" data-panel="phrases">
              {% if plagiarism_data.analyses and plagiarism_data.analyses.common_phrases %}
              {% set phrases = plagiarism_data.analyses.common_phrases %}
              <p style="font-size: 14px; color: #9ca3af; margin-bottom: 16px;">
                Boilerplate density: <strong style="color: {% if phrases.boilerplate_density > 15 %}#ef4444{% elif phrases.boilerplate_density > 8 %}#fbbf24{% else %}#10b981{% endif %};">{{ phrases.boilerplate_density }}%</strong> 
                ({{ phrases.risk_level | title }} Risk)
              </p>
              {% if phrases.common_phrases %}
              <div class="phrase-list" style="display: flex; flex-direction: column; gap: 8px;">
                {% for phrase in phrases.common_phrases[:10] %}
                <div class="phrase-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 10px;">
                  <span class="phrase-text" style="color: #e5e7eb; font-size: 13px;">"{{ phrase.phrase }}"</span>
                  <span class="phrase-count" style="background: rgba(138, 243, 255, 0.15); color: #8af3ff; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">{{ phrase.count }}x</span>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty-state" style="padding: 24px; background: rgba(255, 255, 255, 0.02); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.06); text-align: center;">
                <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; stroke: #10b981; fill: none; stroke-width: 2;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <h4 style="color: #10b981; margin-top: 12px; font-size: 14px;">Low Boilerplate Usage</h4>
                <p style="color: #9ca3af; font-size: 13px;">Document shows minimal use of common academic phrases.</p>
              </div>
              {% endif %}
              {% endif %}
            </div>

            <!-- Style Panel -->
            <div class="analysis-panel" data-panel="style">
              {% if plagiarism_data.analyses and plagiarism_data.analyses.style_consistency %}
              {% set style = plagiarism_data.analyses.style_consistency %}
              <p style="font-size: 14px; color: #9ca3af; margin-bottom: 16px;">
                Style Consistency Score: <strong style="color: #8af3ff;">{{ style.consistency_score }}%</strong>
                ({{ style.paragraph_count | default(0) }} paragraphs analyzed)
              </p>
              {% if style.variations %}
              <div class="issues-list" style="display: flex; flex-direction: column; gap: 10px;">
                {% for variation in style.variations %}
                <div class="issue-item" style="display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 10px;">
                  <div class="issue-icon" style="width: 28px; height: 28px; border-radius: 8px; background: {% if variation.severity == 'high' %}rgba(239, 68, 68, 0.15){% elif variation.severity == 'medium' %}rgba(251, 191, 36, 0.15){% else %}rgba(138, 243, 255, 0.15){% endif %}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: {% if variation.severity == 'high' %}#ef4444{% elif variation.severity == 'medium' %}#fbbf24{% else %}#8af3ff{% endif %}; fill: none; stroke-width: 2;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                  </div>
                  <div class="issue-content" style="flex: 1;">
                    <div class="issue-type" style="font-size: 12px; font-weight: 600; color: #8af3ff; text-transform: capitalize;">{{ variation.metric | replace('_', ' ') }}</div>
                    <div class="issue-message" style="font-size: 13px; color: #9ca3af; margin-top: 4px; line-height: 1.5;">{{ variation.description }}</div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty-state" style="padding: 24px; background: rgba(255, 255, 255, 0.02); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.06); text-align: center;">
                <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; stroke: #10b981; fill: none; stroke-width: 2;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <h4 style="color: #10b981; margin-top: 12px; font-size: 14px;">Consistent Style</h4>
                <p style="color: #9ca3af; font-size: 13px;">Writing style remains uniform throughout the document.</p>
              </div>
              {% endif %}
              {% endif %}
            </div>

            <!-- LLM Assessment -->
            {% if plagiarism_data.llm_enhanced and plagiarism_data.llm_assessment %}
            <div class="llm-assessment" style="margin-top: 24px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px;">
              <div class="llm-assessment-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="width: 36px; height: 36px; background: rgba(168, 85, 247, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: #a855f7; fill: none; stroke-width: 2;"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
                </div>
                <div>
                  <div style="font-size: 14px; font-weight: 600; color: #a855f7;">AI Assessment</div>
                  <div style="font-size: 11px; color: #9ca3af;">Deep analysis insights</div>
                </div>
              </div>
              <p class="llm-assessment-text" style="font-size: 14px; color: #e5e7eb; line-height: 1.7; margin: 0;">{{ plagiarism_data.llm_assessment }}</p>
              {% if plagiarism_data.llm_recommendations %}
              <ul class="llm-recommendations" style="margin-top: 16px; padding-left: 0; list-style: none;">
                {% for rec in plagiarism_data.llm_recommendations %}
                <li style="display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-top: 1px solid rgba(255, 255, 255, 0.06); font-size: 13px; color: #9ca3af;">
                  <span style="color: #8af3ff; font-weight: 600;">â†’</span>{{ rec }}
                </li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
        </div>
        {% endif %}

        <!-- Citation Tab Content -->
        {% if citation_data %}
        <div class="analysis-tab-content {% if not plagiarism_data %}active{% endif %}" data-tab="citation">
          <div class="citation-section">
            <div class="citation-panel">
              <div class="citation-header">
                <div class="citation-title">
                  <svg viewBox="0 0 24 24"><path d="M6 2h9a2 2 0 0 1 2 2v2"></path><path d="M6 22h12a2 2 0 0 0 2-2V9.5L14.5 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18v-6"></path><path d="M9 15l3 3 3-3"></path></svg>
                  Citation Analysis
                </div>
                <div class="citation-score-container">
                  <div class="citation-score-ring">
                    <svg viewBox="0 0 36 36">
                      <circle class="citation-ring-bg" cx="18" cy="18" r="15"></circle>
                      <circle class="citation-ring-progress {{ citation_data.risk_level | default('good') }}" 
                              cx="18" cy="18" r="15"
                              stroke-dasharray="{{ ((citation_data.citation_score | default(75)) / 100) * 94.2 }} 94.2"></circle>
                    </svg>
                    <span class="citation-score-text {{ citation_data.risk_level | default('good') }}">{{ citation_data.citation_score | default(75) }}</span>
                  </div>
                  <div class="citation-status">
                    <div class="citation-status-label">Citation Quality</div>
                    <div class="citation-status-value" style="color: {% if citation_data.risk_level == 'excellent' %}#10b981{% elif citation_data.risk_level == 'good' %}#8af3ff{% elif citation_data.risk_level == 'needs_improvement' %}#fbbf24{% else %}#ef4444{% endif %};">
                      {{ citation_data.risk_level | default('good') | replace('_', ' ') | title }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="citation-content">
            <!-- Stats Grid -->
            <div class="citation-stats-grid">
              <div class="citation-stat-card">
                <div class="citation-stat-icon gold">
                  <svg viewBox="0 0 24 24"><path d="M6 2h9a2 2 0 0 1 2 2v2"></path><path d="M6 22h12a2 2 0 0 0 2-2V9.5L14.5 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"></path></svg>
                </div>
                <div class="citation-stat-value">{{ citation_data.total_citations | default(0) }}</div>
                <div class="citation-stat-label">Citations Found</div>
              </div>
              <div class="citation-stat-card">
                <div class="citation-stat-icon cyan">
                  <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                </div>
                <div class="citation-stat-value">{{ citation_data.total_references | default(0) }}</div>
                <div class="citation-stat-label">References</div>
              </div>
              <div class="citation-stat-card">
                <div class="citation-stat-icon green">
                  <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <div class="citation-stat-value">{{ citation_data.verified_count | default(0) }}</div>
                <div class="citation-stat-label">Verified Refs</div>
              </div>
              <div class="citation-stat-card">
                <div class="citation-stat-icon red">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                </div>
                <div class="citation-stat-value">{{ citation_data.issues | length | default(0) }}</div>
                <div class="citation-stat-label">Issues Found</div>
              </div>
            </div>

            <!-- Citation Tabs -->
            <div class="citation-tabs" id="citation-tabs">
              <button class="citation-tab active" data-citpanel="issues">Issues & Recommendations</button>
              <button class="citation-tab" data-citpanel="references">References ({{ citation_data.total_references | default(0) }})</button>
              <button class="citation-tab" data-citpanel="claims">Unsupported Claims</button>
              <button class="citation-tab" data-citpanel="density">Density Analysis</button>
            </div>

            <!-- Issues Panel -->
            <div class="citation-tab-panel active" data-citpanel="issues">
              {% if citation_data.issues %}
              {% for issue in citation_data.issues %}
              <div class="citation-issue-card {{ issue.severity | default('minor') }}">
                <div class="citation-issue-header">
                  <span class="citation-issue-type {{ issue.severity | default('minor') }}">{{ issue.severity | default('minor') }}</span>
                  <span class="citation-issue-title">{{ issue.title }}</span>
                </div>
                <div class="citation-issue-description">{{ issue.description }}</div>
                {% if issue.recommendation %}
                <div class="citation-issue-recommendation">{{ issue.recommendation }}</div>
                {% endif %}
              </div>
              {% endfor %}
              {% else %}
              <div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <h4>No Major Issues</h4>
                <p>Citation practices appear to be well-maintained.</p>
              </div>
              {% endif %}

              <!-- LLM Citation Assessment -->
              {% if citation_data.llm_analysis %}
              <div class="llm-citation-assessment">
                <div class="llm-citation-header">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
                  AI Citation Assessment
                  {% if citation_data.llm_analysis.credibility %}
                  <span class="credibility-badge {{ citation_data.llm_analysis.credibility }}">{{ citation_data.llm_analysis.credibility }} Credibility</span>
                  {% endif %}
                </div>
                <p class="llm-assessment-text">{{ citation_data.llm_analysis.assessment | default('No assessment available.') }}</p>
                {% if citation_data.llm_analysis.recommendations %}
                <ul class="llm-recommendations">
                  {% for rec in citation_data.llm_analysis.recommendations %}
                  <li>{{ rec }}</li>
                  {% endfor %}
                </ul>
                {% endif %}
              </div>
              {% endif %}
            </div>

            <!-- References Panel -->
            <div class="citation-tab-panel" data-citpanel="references">
              {% if citation_data.references %}
              <div class="reference-list">
                {% for ref in citation_data.references %}
                <div class="reference-item">
                  <div class="reference-header">
                    <span class="reference-number">{{ ref.number }}</span>
                    {% if ref.verification %}
                    <span class="reference-verification {% if ref.verification.verified %}verified{% elif ref.verification.confidence > 0.5 %}partial{% else %}unverified{% endif %}">
                      {% if ref.verification.verified %}âœ“ Verified{% elif ref.verification.confidence > 0.5 %}Partial{% else %}âš  Unverified{% endif %}
                    </span>
                    {% endif %}
                    {% if ref.year %}
                    <span class="reference-meta-item">
                      <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                      {{ ref.year }}
                    </span>
                    {% endif %}
                  </div>
                  <div class="reference-text">{{ ref.raw_text[:200] }}{% if ref.raw_text | length > 200 %}...{% endif %}</div>
                  <div class="reference-meta">
                    {% if ref.doi %}
                    <span class="reference-meta-item">
                      <svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                      DOI: {{ ref.doi[:30] }}...
                    </span>
                    {% endif %}
                    {% if ref.title %}
                    <span class="reference-meta-item" title="{{ ref.title }}">
                      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg>
                      {{ ref.title[:40] }}{% if ref.title | length > 40 %}...{% endif %}
                    </span>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <h4>No References Found</h4>
                <p>Could not detect a references section in the document.</p>
              </div>
              {% endif %}
            </div>

            <!-- Unsupported Claims Panel -->
            <div class="citation-tab-panel" data-citpanel="claims">
              {% if citation_data.unsupported_claims %}
              <p style="font-size: 13px; color: #9ca3af; margin-bottom: 16px;">
                These statements typically require citations but appear to lack proper references:
              </p>
              {% for claim in citation_data.unsupported_claims %}
              <div class="claim-item">
                <div class="claim-type">{{ claim.type }}</div>
                <div class="claim-context">
                  {{ claim.context | replace(claim.text, '<mark>' ~ claim.text ~ '</mark>') | safe }}
                </div>
                <div class="claim-location">Page {{ claim.page }}</div>
              </div>
              {% endfor %}
              {% else %}
              <div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <h4>All Claims Appear Supported</h4>
                <p>No obvious unsupported claims detected.</p>
              </div>
              {% endif %}
            </div>

            <!-- Density Analysis Panel -->
            <div class="citation-tab-panel" data-citpanel="density">
              {% if citation_data.citation_density %}
              <div class="citation-stats-grid" style="margin-bottom: 20px;">
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{{ citation_data.citation_density.citations_per_1000_words | default(0) }}</div>
                  <div class="citation-stat-label">Per 1000 Words</div>
                </div>
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{{ citation_data.citation_density.citations_per_sentence | default(0) }}</div>
                  <div class="citation-stat-label">Per Sentence</div>
                </div>
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{{ citation_data.styles_found | length | default(0) }}</div>
                  <div class="citation-stat-label">Styles Found</div>
                </div>
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{% if citation_data.styles_found %}{{ citation_data.styles_found[0] | replace('_', ' ') | title }}{% else %}None{% endif %}</div>
                  <div class="citation-stat-label">Primary Style</div>
                </div>
              </div>

              {% if citation_data.reference_quality %}
              <h5 style="font-size: 14px; color: #fbbf24; margin-bottom: 12px;">Reference Quality Metrics</h5>
              <div class="citation-stats-grid">
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{{ citation_data.reference_quality.avg_year | default('N/A') }}</div>
                  <div class="citation-stat-label">Average Year</div>
                </div>
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{{ citation_data.reference_quality.recent_refs_count | default(0) }}</div>
                  <div class="citation-stat-label">Recent (2020+)</div>
                </div>
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{{ citation_data.reference_quality.outdated_refs_count | default(0) }}</div>
                  <div class="citation-stat-label">Outdated (&lt;2010)</div>
                </div>
                <div class="citation-stat-card">
                  <div class="citation-stat-value">{{ citation_data.reference_quality.newest_year | default('N/A') }}-{{ citation_data.reference_quality.oldest_year | default('N/A') }}</div>
                  <div class="citation-stat-label">Year Range</div>
                </div>
              </div>
              {% endif %}

              {% if citation_data.page_distribution %}
              <h5 style="font-size: 14px; color: #fbbf24; margin: 20px 0 12px;">Citation Distribution by Page</h5>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                {% for page, count in citation_data.page_distribution.items() %}
                <div style="padding: 10px 14px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 8px; text-align: center;">
                  <div style="font-size: 16px; font-weight: 700; color: #fbbf24;">{{ count }}</div>
                  <div style="font-size: 10px; color: #9ca3af;">Page {{ page }}</div>
                </div>
                {% endfor %}
              </div>
              {% endif %}
              {% else %}
              <div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>
                <h4>No Density Data</h4>
                <p>Unable to calculate citation density metrics.</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
        </div>
        {% endif %}

        <!-- Rewrite Tab Content -->
        {% if rewrite_data and rewrite_data.opportunities %}
        <div class="analysis-tab-content {% if not plagiarism_data and not citation_data %}active{% endif %}" data-tab="rewrite">
          <div class="rewrite-section">
            <div class="rewrite-panel">
              <div class="rewrite-header">
                <div class="rewrite-title">
                  <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                  Rewrite-to-Accept
                </div>
                <div class="rewrite-badge">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                  {{ rewrite_data.stats.rewrite_ready_count | default(0) }} Ready to Rewrite
                </div>
              </div>

              <div class="rewrite-content">
                <!-- Stats Overview -->
                <div class="rewrite-stats">
                  <div class="rewrite-stat">
                    <div class="rewrite-stat-icon critical">
                      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    </div>
                    <div class="rewrite-stat-value">{{ rewrite_data.stats.critical_count | default(0) }}</div>
                    <div class="rewrite-stat-label">Critical</div>
                  </div>
                  <div class="rewrite-stat">
                    <div class="rewrite-stat-icon high">
                      <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path></svg>
                    </div>
                    <div class="rewrite-stat-value">{{ rewrite_data.stats.high_count | default(0) }}</div>
                    <div class="rewrite-stat-label">High Priority</div>
                  </div>
                  <div class="rewrite-stat">
                    <div class="rewrite-stat-icon medium">
                  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </div>
                <div class="rewrite-stat-value">{{ rewrite_data.stats.medium_count | default(0) }}</div>
                <div class="rewrite-stat-label">Medium Priority</div>
              </div>
              <div class="rewrite-stat">
                <div class="rewrite-stat-icon ready">
                  <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <div class="rewrite-stat-value">{{ rewrite_data.stats.total_opportunities | default(0) }}</div>
                <div class="rewrite-stat-label">Total Opportunities</div>
              </div>
            </div>

            <!-- Opportunity Cards -->
            <div class="rewrite-opportunities">
              {% for opp in rewrite_data.opportunities[:15] %}
              <div class="opportunity-card" 
                   data-id="{{ opp.id }}"
                   data-type="{{ opp.type }}"
                   data-affected="{{ opp.affected_text | default('') }}"
                   data-description="{{ opp.description | default('') }}"
                   data-fix="{{ opp.suggested_fix | default('') }}"
                   data-section="{{ opp.section_name | default('') }}"
                   data-ready="{{ opp.rewrite_ready | default(false) | lower }}">
                <div class="opportunity-header">
                  <div class="opportunity-priority {{ opp.priority | default('medium') }}">
                    {% if opp.priority == 'critical' %}
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    {% elif opp.priority == 'high' %}
                    <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path></svg>
                    {% else %}
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    {% endif %}
                  </div>
                  <div class="opportunity-main">
                    <span class="opportunity-source">{{ opp.source | default('general') }}</span>
                    <div class="opportunity-title">{{ opp.title }}</div>
                    <div class="opportunity-description">{{ opp.description[:120] }}{% if opp.description|length > 120 %}...{% endif %}</div>
                    <div class="opportunity-location">ðŸ“ {{ opp.location | default('Document') }}</div>
                  </div>
                  <div class="opportunity-expand">
                    <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  </div>
                </div>

                <div class="rewrite-details">
                  {% if opp.affected_text %}
                  <div class="rewrite-comparison">
                    <div class="rewrite-original">
                      <div class="rewrite-label">
                        <svg viewBox="0 0 24 24" style="width: 14px; height: 14px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        Original Text
                      </div>
                      <div class="rewrite-text original-text">{{ opp.affected_text[:200] }}{% if opp.affected_text|length > 200 %}...{% endif %}</div>
                    </div>
                    <div class="rewrite-improved">
                      <div class="rewrite-label">
                        <svg viewBox="0 0 24 24" style="width: 14px; height: 14px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Improved Version
                      </div>
                      <div class="rewrite-text improved-text" id="rewrite-{{ opp.id }}">
                        <em style="color: #6b7280;">Click "Generate Rewrite" to see the improved version</em>
                      </div>
                    </div>
                  </div>
                  {% endif %}

                  <div class="rewrite-actions">
                    <button class="rewrite-btn rewrite-btn-primary generate-rewrite-btn" data-id="{{ opp.id }}">
                      <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                      Generate Rewrite
                    </button>
                    <button class="rewrite-btn rewrite-btn-secondary copy-rewrite-btn" data-id="{{ opp.id }}" style="display: none;">
                      <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                      Copy
                    </button>
                    <button class="rewrite-btn rewrite-btn-success apply-rewrite-btn" data-id="{{ opp.id }}" style="display: none;">
                      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                      Applied
                    </button>
                  </div>

                  <div class="changes-list" id="changes-{{ opp.id }}" style="display: none;">
                    <div class="changes-list-title">Changes Made</div>
                    <ul class="changes-items"></ul>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <!-- Section Quick Rewrites -->
            {% if rewrite_data.sections %}
            <div class="section-rewrites">
              <div class="section-rewrites-title">
                <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                Quick Section Rewrites
              </div>
              {% for section_name, section_preview in rewrite_data.sections.items() %}
       section_name not in ['preamble', 'references'] %}
              <div class="section-card" data-section="{{ section_name }}">
                <div class="section-info">
                  <div class="section-name">{{ section_name | replace('_', ' ') }}</div>
                  <div class="section-preview">{{ section_preview[:80] }}{% if section_preview|length > 80 %}...{% endif %}</div>
                </div>
                <button class="rewrite-btn rewrite-btn-primary section-rewrite-btn" data-section="{{ section_name }}">
                  <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                  Improve
                </button>
              </div>
              {% endif %}
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
        </div>
        {% endif %}

      </div>
      {% endif %}
      <!-- End of Analysis Tabs Container -->

      <!-- Chatbot Section -->
      <div class="chatbot-wrapper">
        <div class="chatbot-section-header">
          <div class="chatbot-pill">
            <div class="status-dots"><span></span><span></span><span></span></div>
            <span>AI Research Assistant</span>
          </div>
          <div class="chatbot-section-title">Paper-aware Chatbot</div>
          <div class="chatbot-section-sub">Ask questions about your paper's analysis, get improvement suggestions, or clarify any findings.</div>
        </div>

        <div class="chat-shell">
          <div class="chatbot-container">
            <div class="chatbot-robot">
              <spline-viewer url="https://prod.spline.design/oNMzWOQrsYUZkE-4/scene.splinecode"></spline-viewer>
            </div>
            <div class="chat-panel">
              <div class="chat-messages" id="chat-messages">
                <div class="chat-message bot">
                  <div class="sender">AI Assistant</div>
                  <div class="text">Hello! I'm your AI Research Assistant. I've analyzed your paper and I'm ready to help. Ask me about the plagiarism findings, citation issues, formatting suggestions, or how to improve specific sections of your paper.</div>
                </div>
              </div>
              <div class="chat-input-area">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask about your paper analysis..." autocomplete="off">
                <button class="chat-send-btn" id="chat-send-btn">Send</button>
              </div>
              <div class="chat-disclaimer">
                âš ï¸ <strong>Note:</strong> AI suggestions are advisory only. Always verify recommendations and use your academic judgment.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <a href="/" class="btn btn-secondary">
          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg>
          Upload Another
        </a>
        <button class="btn btn-primary" onclick="downloadText()">
          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          Download Text
        </button>
      </div>
    </div>
  </div>

  <!-- Section Rewrite Modal -->
  <div class="rewrite-modal" id="section-rewrite-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-section-title">Section Rewrite</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modal-loading" class="modal-loading" style="display: flex;">
          <div class="loading-spinner-large"></div>
          <span>Generating improved version...</span>
        </div>
        <div id="modal-content-area" style="display: none;">
          <div class="comparison-view" style="display: grid;">
            <div class="comparison-column original">
              <div class="comparison-header">Original</div>
              <div class="comparison-content" id="modal-original-text"></div>
            </div>
            <div class="comparison-column improved">
              <div class="comparison-header">
                <svg viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                AI Improved
              </div>
              <div class="comparison-content rewritten-text-content" id="modal-rewritten-text"></div>
            </div>
          </div>
          <div class="changes-made">
            <div class="changes-title">
              <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
              Changes Made
            </div>
            <ul class="changes-list" id="modal-changes-list"></ul>
          </div>
          <div class="rewrite-action-btns" style="display: flex; margin-top: 20px;">
            <button class="rewrite-btn rewrite-btn-secondary copy-rewrite-btn">
              <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              Copy to Clipboard
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // PDF.js initialization
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Store extracted text for download
    const extractedText = {{ extracted_text | tojson }};
    const isPdf = {{ is_pdf | tojson if is_pdf is defined else 'false' }};
    const pdfBase64 = {{ pdf_base64 | tojson if pdf_base64 else 'null' }};

    // PDF Viewer State
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let scale = 1.5;
    let rendering = false;

    // DOM Elements
    const pdfCanvas = document.getElementById('pdf-canvas');
    const pdfContainer = document.getElementById('pdf-container');
    const pdfWrapper = document.getElementById('pdf-wrapper');
    const pdfLoading = document.getElementById('pdf-loading');
    const highlightOverlay = document.getElementById('highlight-overlay');
    const scanLine = document.getElementById('scan-line');
    const connectionLine = document.getElementById('connection-line');
    const connectionPath = document.getElementById('connection-path');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const currentPageSpan = document.getElementById('current-page');
    const totalPagesSpan = document.getElementById('total-pages');

    // Initialize PDF if available
    if (isPdf && pdfBase64) {
      loadPdf();
    }

    async function loadPdf() {
      try {
        const pdfData = atob(pdfBase64);
        const pdfArray = new Uint8Array(pdfData.length);
        for (let i = 0; i < pdfData.length; i++) {
          pdfArray[i] = pdfData.charCodeAt(i);
        }

        pdfDoc = await pdfjsLib.getDocument({ data: pdfArray }).promise;
        totalPages = pdfDoc.numPages;
        totalPagesSpan.textContent = totalPages;

        // Render first page
        await renderPage(1);

        // Show PDF
        pdfLoading.style.display = 'none';
        pdfWrapper.style.display = 'block';

        // Enable/disable navigation
        updateNavButtons();
      } catch (error) {
        console.error('PDF loading error:', error);
        pdfLoading.innerHTML = '<span style="color: #ef4444;">Failed to load PDF</span>';
      }
    }

    async function renderPage(pageNum) {
      if (rendering) return;
      rendering = true;

      try {
        const page = await pdfDoc.getPage(pageNum);
        
        // Calculate scale to fit container
        const containerWidth = pdfContainer.clientWidth - 40;
        const containerHeight = pdfContainer.clientHeight - 40;
        
        const viewport = page.getViewport({ scale: 1 });
        const scaleX = containerWidth / viewport.width;
        const scaleY = containerHeight / viewport.height;
        scale = Math.min(scaleX, scaleY, 2);

        const scaledViewport = page.getViewport({ scale });
        
        pdfCanvas.width = scaledViewport.width;
        pdfCanvas.height = scaledViewport.height;

        const ctx = pdfCanvas.getContext('2d');
        await page.render({
          canvasContext: ctx,
          viewport: scaledViewport
        }).promise;

        currentPage = pageNum;
        currentPageSpan.textContent = pageNum;
        updateNavButtons();

        // Clear highlights when changing pages
        clearHighlights();
      } catch (error) {
        console.error('Page render error:', error);
      } finally {
        rendering = false;
      }
    }

    function updateNavButtons() {
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    }

    // Navigation event listeners
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          renderPage(currentPage - 1);
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          renderPage(currentPage + 1);
        }
      });
    }

    // Text functions
    function copyText() {
      navigator.clipboard.writeText(extractedText).then(() => {
        showNotification('Text copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    function downloadText() {
      const filename = '{{ filename }}'.replace(/\.[^/.]+$/, '') + '_extracted.txt';
      const blob = new Blob([extractedText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: linear-gradient(135deg, rgba(138, 243, 255, 0.9), rgba(94, 210, 255, 0.9));
        color: #050505;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 10px 40px rgba(138, 243, 255, 0.4);
        animation: fadeInUp 0.3s ease-out;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(-50%) translateY(10px)';
        notification.style.transition = 'all 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Page tab switching
    const pageTabs = document.querySelectorAll('.page-tab');
    const pageSuggestions = document.querySelectorAll('.page-suggestions');

    pageTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const pageNum = tab.dataset.page;
        
        // Update active tab
        pageTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show corresponding suggestions
        pageSuggestions.forEach(ps => {
          if (ps.dataset.page === pageNum) {
            ps.classList.add('active');
          } else {
            ps.classList.remove('active');
          }
        });

        // If PDF and page number, navigate to that page
        if (isPdf && pdfDoc && pageNum !== 'overall') {
          const targetPage = parseInt(pageNum);
          if (targetPage && targetPage !== currentPage) {
            renderPage(targetPage);
          }
        }
      });
    });

    // Suggestion card expand/collapse and highlight mapping
    const suggestionCards = document.querySelectorAll('.suggestion-card');

    suggestionCards.forEach(card => {
      card.addEventListener('click', (e) => {
        const wasExpanded = card.classList.contains('expanded');
        suggestionCards.forEach(c => c.classList.remove('expanded'));
        if (!wasExpanded) {
          card.classList.add('expanded');
        }
      });

      // Hover effects with PDF highlight mapping
      card.addEventListener('mouseenter', () => {
        if (isPdf && pdfDoc) {
          const pageNum = parseInt(card.dataset.page);
          
          // Navigate to the relevant page if needed
          if (pageNum && pageNum !== currentPage && pageNum > 0) {
            renderPage(pageNum).then(() => {
              showHighlightOnPdf(card);
            });
          } else if (pageNum > 0) {
            showHighlightOnPdf(card);
          }
        }
      });

      card.addEventListener('mouseleave', () => {
        clearHighlights();
        hideConnectionLine();
      });
    });

    function showHighlightOnPdf(card) {
      if (!highlightOverlay || !pdfCanvas) return;

      // Get location data from card (normalized 0-1 values)
      const locY = parseFloat(card.dataset.locationY) || 0.3;
      const locX = parseFloat(card.dataset.locationX) || 0.1;
      const locWidth = parseFloat(card.dataset.locationWidth) || 0.8;
      const locHeight = parseFloat(card.dataset.locationHeight) || 0.06;

      // Clear existing highlights
      highlightOverlay.innerHTML = '';

      // Create highlight box
      const highlightBox = document.createElement('div');
      highlightBox.className = 'highlight-box';
      
      // Position based on normalized coordinates (0-1 range)
      highlightBox.style.left = (locX * 100) + '%';
      highlightBox.style.top = (locY * 100) + '%';
      highlightBox.style.width = (locWidth * 100) + '%';
      highlightBox.style.height = Math.max(locHeight * 100, 3) + '%';

      highlightOverlay.appendChild(highlightBox);

      // Animate in
      requestAnimationFrame(() => {
        highlightBox.classList.add('active');
      });

      // Show scan line effect
      if (scanLine) {
        scanLine.style.top = '0';
        scanLine.classList.add('active');
        setTimeout(() => {
          scanLine.classList.remove('active');
        }, 1500);
      }

      // Draw connection line after a short delay to ensure highlight is rendered
      setTimeout(() => {
        drawConnectionLine(card, highlightBox);
      }, 50);
    }

    function drawConnectionLine(card, highlightBox) {
      if (!connectionLine || !connectionPath) return;

      // Get bounding rectangles
      const cardRect = card.getBoundingClientRect();
      const highlightRect = highlightBox.getBoundingClientRect();
      const pdfWrapperRect = pdfWrapper ? pdfWrapper.getBoundingClientRect() : null;

      // Check if elements are visible
      if (!highlightRect.width || !highlightRect.height) return;

      // Start point: left center of the suggestion card
      const startX = cardRect.left;
      const startY = cardRect.top + (cardRect.height / 2);

      // End point: right center of the highlight box
      const endX = highlightRect.right;
      const endY = highlightRect.top + (highlightRect.height / 2);

      // Calculate control points for smooth curve
      const deltaX = Math.abs(startX - endX);
      const controlOffset = Math.min(deltaX * 0.4, 150);

      // Create path from highlight to card (right to left)
      const pathD = `M ${endX} ${endY} C ${endX + controlOffset} ${endY}, ${startX - controlOffset} ${startY}, ${startX} ${startY}`;
      
      connectionPath.setAttribute('d', pathD);
      
      // Position SVG to cover the entire viewport
      connectionLine.style.position = 'fixed';
      connectionLine.style.width = '100vw';
      connectionLine.style.height = '100vh';
      connectionLine.style.left = '0';
      connectionLine.style.top = '0';
      connectionLine.style.pointerEvents = 'none';
      connectionLine.classList.add('active');
    }

    function clearHighlights() {
      if (highlightOverlay) {
        highlightOverlay.innerHTML = '';
      }
    }

    function hideConnectionLine() {
      if (connectionLine) {
        connectionLine.classList.remove('active');
      }
    }

    // Tooltip functionality
    const tooltip = document.getElementById('tooltip');
    const tooltipTitle = tooltip.querySelector('.tooltip-title');
    const tooltipDesc = tooltip.querySelector('.tooltip-desc');
    const tooltipFix = tooltip.querySelector('.tooltip-fix');
    let tooltipTimeout;

    suggestionCards.forEach(card => {
      card.addEventListener('mouseenter', (e) => {
        clearTimeout(tooltipTimeout);
        
        const title = card.dataset.title || '';
        const description = card.dataset.description || '';
        const fix = card.dataset.fix || '';
        
        if (title || description) {
          tooltipTitle.textContent = title;
          tooltipDesc.textContent = description.substring(0, 150) + (description.length > 150 ? '...' : '');
          tooltipFix.textContent = fix ? 'ðŸ’¡ ' + fix.substring(0, 100) + (fix.length > 100 ? '...' : '') : '';
          tooltipFix.style.display = fix ? 'block' : 'none';
          
          tooltipTimeout = setTimeout(() => {
            positionTooltip(e);
            tooltip.classList.add('visible');
          }, 400);
        }
      });

      card.addEventListener('mousemove', (e) => {
        if (tooltip.classList.contains('visible')) {
          positionTooltip(e);
        }
      });

      card.addEventListener('mouseleave', () => {
        clearTimeout(tooltipTimeout);
        tooltip.classList.remove('visible');
      });
    });

    function positionTooltip(e) {
      const x = e.clientX + 15;
      const y = e.clientY + 15;
      
      const tooltipRect = tooltip.getBoundingClientRect();
      const maxX = window.innerWidth - tooltipRect.width - 20;
      const maxY = window.innerHeight - tooltipRect.height - 20;
      
      tooltip.style.left = Math.min(x, maxX) + 'px';
      tooltip.style.top = Math.min(y, maxY) + 'px';
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        suggestionCards.forEach(c => c.classList.remove('expanded'));
        tooltip.classList.remove('visible');
        clearHighlights();
        hideConnectionLine();
      }
      
      // Arrow keys for PDF navigation
      if (isPdf && pdfDoc) {
        if (e.key === 'ArrowLeft' && currentPage > 1) {
          renderPage(currentPage - 1);
        } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
          renderPage(currentPage + 1);
        }
      }
    });

    // Resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (isPdf && pdfDoc && currentPage) {
          renderPage(currentPage);
        }
      }, 200);
    });

    // ==========================================
    // TOP-LEVEL ANALYSIS TABS SWITCHING
    // ==========================================
    const analysisTabBtns = document.querySelectorAll('.analysis-tab-btn');
    const analysisTabContents = document.querySelectorAll('.analysis-tab-content');

    analysisTabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;
        
        // Update active tab button
        analysisTabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Show corresponding tab content
        analysisTabContents.forEach(content => {
          if (content.dataset.tab === tabName) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });

        // Trigger any animations for the newly visible tab
        if (tabName === 'plagiarism') {
          animateScoreCircle();
        } else if (tabName === 'citation') {
          animateCitationRing();
        }
      });
    });

    // Plagiarism Analysis Tab Switching
    const plagiarismTabs = document.querySelectorAll('#plagiarism-tabs .analysis-tab');
    const analysisPanels = document.querySelectorAll('.analysis-panel');

    plagiarismTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const panelName = tab.dataset.panel;
        
        // Update active tab
        plagiarismTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show corresponding panel
        analysisPanels.forEach(panel => {
          if (panel.dataset.panel === panelName) {
            panel.classList.add('active');
          } else {
            panel.classList.remove('active');
          }
        });
      });
    });

    // Radar Chart - Cursor Interactive Sweep + Data Points
    const radarContainer = document.querySelector('.radar-chart-container');
    const radarSweep = document.querySelector('.radar-sweep');

    const radarAxes = [
      { key: 'duplicates', label: 'Duplicates', angle: -90 },
      { key: 'vocabulary', label: 'Vocabulary', angle: 0 },
      { key: 'originality', label: 'Originality', angle: 90 },
      { key: 'style', label: 'Style', angle: 180 }
    ];

    function initRadarChart() {
      if (!radarContainer) return;

      const svg = radarContainer.querySelector('.radar-svg');
      const area = radarContainer.querySelector('.radar-area');
      const outline = radarContainer.querySelector('.radar-outline');
      const points = Array.from(radarContainer.querySelectorAll('.radar-point'));
      const labels = Array.from(radarContainer.querySelectorAll('.radar-label'));
      const tooltip = radarContainer.querySelector('.radar-tooltip');

      if (!svg || !area || !outline || points.length === 0) return;

      const values = {
        duplicates: Number(radarContainer.dataset.duplicates) || 0,
        vocabulary: Number(radarContainer.dataset.vocabulary) || 0,
        originality: Number(radarContainer.dataset.originality) || 0,
        style: Number(radarContainer.dataset.style) || 0
      };

      const center = 100;
      const maxRadius = 70;
      const labelRadius = 88;
      const scaleX = radarContainer.clientWidth / 200;
      const scaleY = radarContainer.clientHeight / 200;

      const clamp = (val) => Math.max(0, Math.min(100, val));
      const toPoint = (value, angleDeg, radius = maxRadius) => {
        const r = (clamp(value) / 100) * radius;
        const rad = (angleDeg * Math.PI) / 180;
        return {
          x: center + Math.cos(rad) * r,
          y: center + Math.sin(rad) * r
        };
      };

      const axisPoints = radarAxes.map(axis => {
        const value = values[axis.key];
        const p = toPoint(value, axis.angle);
        return { ...axis, value, x: p.x, y: p.y };
      });

      const polygonPoints = axisPoints.map(p => `${p.x},${p.y}`).join(' ');
      area.setAttribute('points', polygonPoints);
      outline.setAttribute('points', polygonPoints);

      const pointMap = {};
      points.forEach(point => {
        const axisKey = point.dataset.axis;
        const axisPoint = axisPoints.find(p => p.key === axisKey);
        if (!axisPoint) return;
        point.setAttribute('cx', axisPoint.x);
        point.setAttribute('cy', axisPoint.y);
        point.dataset.value = axisPoint.value;
        pointMap[axisKey] = point;
      });

      labels.forEach(label => {
        const axisKey = label.dataset.axis;
        const axis = radarAxes.find(a => a.key === axisKey);
        if (!axis) return;
        const pos = toPoint(100, axis.angle, labelRadius);
        label.style.left = `${pos.x * scaleX}px`;
        label.style.top = `${pos.y * scaleY}px`;
        label.style.transform = 'translate(-50%, -50%)';
      });

      const showTooltip = (axisKey, x, y) => {
        if (!tooltip) return;
        const axis = radarAxes.find(a => a.key === axisKey);
        if (!axis) return;
        const value = values[axisKey];
        tooltip.textContent = `${axis.label}: ${value}%`;
        tooltip.style.left = `${x + 12}px`;
        tooltip.style.top = `${y + 12}px`;
        tooltip.classList.add('show');
      };

      const hideTooltip = () => {
        if (!tooltip) return;
        tooltip.classList.remove('show');
      };

      points.forEach(point => {
        const axisKey = point.dataset.axis;
        point.addEventListener('mouseenter', (e) => {
          const rect = radarContainer.getBoundingClientRect();
          showTooltip(axisKey, e.clientX - rect.left, e.clientY - rect.top);
          point.classList.add('active');
        });
        point.addEventListener('mousemove', (e) => {
          const rect = radarContainer.getBoundingClientRect();
          showTooltip(axisKey, e.clientX - rect.left, e.clientY - rect.top);
        });
        point.addEventListener('mouseleave', () => {
          hideTooltip();
          point.classList.remove('active');
        });
      });

      radarContainer.addEventListener('mousemove', (e) => {
        const rect = radarContainer.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const mouseX = e.clientX - centerX;
        const mouseY = e.clientY - centerY;
        const angle = Math.atan2(mouseY, mouseX) * (180 / Math.PI);
        const normalized = (angle + 360) % 360;

        const closest = radarAxes.reduce((best, axis) => {
          const axisAngle = (axis.angle + 360) % 360;
          const diff = Math.min(Math.abs(axisAngle - normalized), 360 - Math.abs(axisAngle - normalized));
          return diff < best.diff ? { axis, diff } : best;
        }, { axis: radarAxes[0], diff: 360 }).axis;

        Object.values(pointMap).forEach(p => p.classList.remove('active'));
        if (pointMap[closest.key]) pointMap[closest.key].classList.add('active');
      });
    }

    if (radarContainer && radarSweep) {
      radarContainer.addEventListener('mousemove', (e) => {
        const rect = radarContainer.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const mouseX = e.clientX - centerX;
        const mouseY = e.clientY - centerY;
        const angle = Math.atan2(mouseY, mouseX) * (180 / Math.PI);
        radarSweep.style.transform = `rotate(${angle}deg)`;
      });

      radarContainer.addEventListener('mouseleave', () => {
        radarSweep.style.transform = '';
      });
    }

    initRadarChart();

    // Animate score circle function
    function animateScoreCircle() {
      const scoreCircle = document.querySelector('.score-circle-progress');
      if (scoreCircle) {
        const finalOffset = scoreCircle.getAttribute('stroke-dashoffset');
        scoreCircle.style.transition = 'none';
        scoreCircle.style.strokeDashoffset = '97.4';
        
        setTimeout(() => {
          scoreCircle.style.transition = 'stroke-dashoffset 1.5s ease-out';
          scoreCircle.style.strokeDashoffset = finalOffset;
        }, 100);
      }
    }

    // Animate score circle on load
    animateScoreCircle();

    // Citation Analysis Tab Switching
    const citationTabs = document.querySelectorAll('#citation-tabs .citation-tab');
    const citationPanels = document.querySelectorAll('.citation-tab-panel');

    citationTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const panelName = tab.dataset.citpanel;
        
        // Update active tab
        citationTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show corresponding panel
        citationPanels.forEach(panel => {
          if (panel.dataset.citpanel === panelName) {
            panel.classList.add('active');
          } else {
            panel.classList.remove('active');
          }
        });
      });
    });

    // Animate citation score ring function
    function animateCitationRing() {
      const citationScoreRing = document.querySelector('.citation-ring-progress');
      if (citationScoreRing) {
        const dashArray = citationScoreRing.getAttribute('stroke-dasharray');
        citationScoreRing.style.transition = 'none';
        citationScoreRing.style.strokeDasharray = '0 94.2';
        
        setTimeout(() => {
          citationScoreRing.style.transition = 'stroke-dasharray 1.5s ease-out';
          citationScoreRing.style.strokeDasharray = dashArray;
        }, 100);
      }
    }

    // Animate citation score ring on load
    animateCitationRing();

    // ==========================================
    // REWRITE-TO-ACCEPT FUNCTIONALITY
    // ==========================================

    // Opportunity Card Expand/Collapse
    document.querySelectorAll('.opportunity-card').forEach(card => {
      const header = card.querySelector('.opportunity-header');
      const expandIcon = card.querySelector('.expand-icon');
      const details = card.querySelector('.opportunity-details');
      
      if (header && details) {
        header.addEventListener('click', () => {
          const isExpanded = card.classList.contains('expanded');
          
          // Collapse all other cards
          document.querySelectorAll('.opportunity-card.expanded').forEach(otherCard => {
            if (otherCard !== card) {
              otherCard.classList.remove('expanded');
              const otherDetails = otherCard.querySelector('.opportunity-details');
              if (otherDetails) {
                otherDetails.style.maxHeight = '0';
                otherDetails.style.padding = '0 20px';
              }
              const otherIcon = otherCard.querySelector('.expand-icon');
              if (otherIcon) otherIcon.style.transform = 'rotate(0deg)';
            }
          });
          
          // Toggle current card
          if (isExpanded) {
            card.classList.remove('expanded');
            details.style.maxHeight = '0';
            details.style.padding = '0 20px';
            if (expandIcon) expandIcon.style.transform = 'rotate(0deg)';
          } else {
            card.classList.add('expanded');
            details.style.maxHeight = details.scrollHeight + 40 + 'px';
            details.style.padding = '20px';
            if (expandIcon) expandIcon.style.transform = 'rotate(180deg)';
          }
        });
      }
    });

    // Generate Rewrite Button Handler
    document.querySelectorAll('.generate-rewrite-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        
        const card = btn.closest('.opportunity-card');
        const oppType = btn.dataset.oppType;
        const oppId = btn.dataset.oppId;
        const originalText = btn.dataset.originalText;
        const suggestionText = btn.dataset.suggestion;
        
        const rewriteContainer = card.querySelector(`#rewrite-${oppId}`);
        const changesContainer = card.querySelector(`#changes-${oppId}`);
        const comparisonView = card.querySelector('.comparison-view');
        const actionBtns = card.querySelector('.rewrite-action-btns');
        
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> Generating...';
        
        try {
          const response = await fetch('/generate-rewrite', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              type: oppType,
              original_text: originalText,
              suggestion: suggestionText,
              full_text: `{{ extracted_text[:3000] | tojson | safe }}`.slice(1, -1)
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Display rewritten text
            if (rewriteContainer) {
              rewriteContainer.innerHTML = formatRewrittenText(data.rewritten_text);
            }
            
            // Display changes list
            if (changesContainer && data.changes && data.changes.length > 0) {
              changesContainer.innerHTML = data.changes.map(change => 
                `<li><span class="change-icon">âœŽ</span> ${escapeHtml(change)}</li>`
              ).join('');
            }
            
            // Show comparison view and action buttons
            if (comparisonView) comparisonView.style.display = 'grid';
            if (actionBtns) actionBtns.style.display = 'flex';
            
            // Update button
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Regenerate';
            btn.disabled = false;
            
            // Expand the card to show results
            card.classList.add('expanded');
            const details = card.querySelector('.opportunity-details');
            if (details) {
              details.style.maxHeight = details.scrollHeight + 100 + 'px';
              details.style.padding = '20px';
            }
            
          } else {
            throw new Error(data.error || 'Failed to generate rewrite');
          }
          
        } catch (error) {
          console.error('Rewrite generation error:', error);
          btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Retry';
          btn.disabled = false;
          
          if (rewriteContainer) {
            rewriteContainer.innerHTML = `<div class="rewrite-error">
              <span class="error-icon">âš </span>
              Error generating rewrite. Please try again.
            </div>`;
          }
        }
      });
    });

    // Section Rewrite Button Handler
    document.querySelectorAll('.section-rewrite-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const sectionType = btn.dataset.section;
        const modal = document.getElementById('section-rewrite-modal');
        const modalTitle = document.getElementById('modal-section-title');
        const modalOriginal = document.getElementById('modal-original-text');
        const modalRewritten = document.getElementById('modal-rewritten-text');
        const modalChanges = document.getElementById('modal-changes-list');
        const modalLoading = document.getElementById('modal-loading');
        const modalContent = document.getElementById('modal-content-area');
        
        // Show modal
        if (modal) {
          modal.classList.add('active');
          modalTitle.textContent = sectionType.charAt(0).toUpperCase() + sectionType.slice(1) + ' Section';
          modalLoading.style.display = 'flex';
          modalContent.style.display = 'none';
        }
        
        try {
          const response = await fetch('/generate-rewrite', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              type: 'section',
              section_type: sectionType,
              full_text: `{{ extracted_text[:5000] | tojson | safe }}`.slice(1, -1)
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            modalOriginal.textContent = data.original_text || 'Section not found in document.';
            modalRewritten.innerHTML = formatRewrittenText(data.rewritten_text);
            
            if (data.changes && data.changes.length > 0) {
              modalChanges.innerHTML = data.changes.map(change => 
                `<li><span class="change-icon">âœŽ</span> ${escapeHtml(change)}</li>`
              ).join('');
            } else {
              modalChanges.innerHTML = '<li>No specific changes tracked.</li>';
            }
            
            modalLoading.style.display = 'none';
            modalContent.style.display = 'block';
          } else {
            throw new Error(data.error);
          }
          
        } catch (error) {
          console.error('Section rewrite error:', error);
          modalLoading.innerHTML = `<div class="rewrite-error">
            <span class="error-icon">âš </span>
            Error generating section rewrite. Please try again.
          </div>`;
        }
      });
    });

    // Close Modal
    document.querySelectorAll('.modal-close, .modal-overlay').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.rewrite-modal').forEach(modal => {
          modal.classList.remove('active');
        });
      });
    });

    // Copy Rewritten Text
    document.querySelectorAll('.copy-rewrite-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const card = btn.closest('.opportunity-card') || btn.closest('.modal-body');
        const rewriteText = card.querySelector('.rewritten-text-content, #modal-rewritten-text');
        
        if (rewriteText) {
          try {
            await navigator.clipboard.writeText(rewriteText.textContent);
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
            btn.classList.add('copied');
            
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove('copied');
            }, 2000);
          } catch (error) {
            console.error('Copy failed:', error);
          }
        }
      });
    });

    // Apply Rewrite (placeholder - would need document editing capabilities)
    document.querySelectorAll('.apply-rewrite-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const card = btn.closest('.opportunity-card');
        
        // Show applied confirmation
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Applied';
        btn.classList.add('applied');
        
        // Mark card as completed
        card.classList.add('rewrite-applied');
        
        // Update stats
        const appliedCount = document.querySelector('.rewrite-stat-value.applied-count');
        if (appliedCount) {
          appliedCount.textContent = parseInt(appliedCount.textContent) + 1;
        }
      });
    });

    // Helper function to format rewritten text with highlights
    function formatRewrittenText(text) {
      if (!text) return '<em>No rewrite generated.</em>';
      
      // Escape HTML first
      let formatted = escapeHtml(text);
      
      // Highlight key improvements (text in quotes often indicates new phrasing)
      formatted = formatted.replace(/"([^"]+)"/g, '<span class="highlight-phrase">"$1"</span>');
      
      // Preserve paragraphs
      formatted = formatted.replace(/\n\n/g, '</p><p>');
      formatted = formatted.replace(/\n/g, '<br>');
      
      return '<p>' + formatted + '</p>';
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Animate rewrite stats on scroll
    const rewriteSection = document.querySelector('.rewrite-opportunities-section');
    if (rewriteSection) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.querySelectorAll('.rewrite-stat-value').forEach((stat, index) => {
              stat.style.animation = `fadeInUp 0.5s ease ${index * 0.1}s forwards`;
            });
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.2 });
      
      observer.observe(rewriteSection);
    }

    // ==================== CHATBOT FUNCTIONALITY ====================
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');

    // Render markdown content safely
    function renderMarkdown(text) {
      if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
        const rawHtml = marked.parse(text);
        return DOMPurify.sanitize(rawHtml);
      }
      return text.replace(/\n/g, '<br>');
    }

    // Add a message to the chat
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isUser ? 'user' : 'bot'}`;
      
      const senderDiv = document.createElement('div');
      senderDiv.className = 'sender';
      senderDiv.textContent = isUser ? 'You' : 'AI Assistant';
      
      const textDiv = document.createElement('div');
      textDiv.className = 'text';
      textDiv.innerHTML = isUser ? content : renderMarkdown(content);
      
      messageDiv.appendChild(senderDiv);
      messageDiv.appendChild(textDiv);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Show typing indicator
    function showTyping() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'chat-message bot';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="sender">AI Assistant</div>
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Remove typing indicator
    function removeTyping() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    // Get paper context from the analysis results
    function getPaperContext() {
      let context = "=== RESEARCH PAPER ANALYSIS CONTEXT ===\n\n";
      
      // Get filename and basic info
      context += "--- Document Information ---\n";
      context += `Filename: {{ filename }}\n`;
      context += `Word Count: {{ word_count | default(0) }}\n`;
      context += `Character Count: {{ char_count | default(0) }}\n`;
      {% if formatting_data and formatting_data.score %}
      context += `Formatting Score: {{ formatting_data.score }}/100\n`;
      {% endif %}
      context += "\n";
      
      // Get the full extracted text (up to 4000 chars for better context)
      context += "--- Paper Content (Extracted Text) ---\n";
      const fullText = {{ extracted_text | tojson }};
      if (fullText) {
        context += fullText.substring(0, 4000);
        if (fullText.length > 4000) {
          context += "\n[... content truncated for brevity ...]\n";
        }
      }
      context += "\n\n";
      
      // Get plagiarism analysis details
      {% if plagiarism_data %}
      context += "--- Plagiarism Analysis Results ---\n";
      context += `Overall Originality Score: {{ plagiarism_data.overall_score | default(0) | round(1) }}%\n`;
      context += `Risk Level: {{ plagiarism_data.risk_level | default('unknown') }}\n`;
      {% if plagiarism_data.component_scores %}
      context += "Component Scores:\n";
      context += `  - Duplicate Check: {{ plagiarism_data.component_scores.duplicate_check | default(0) }}%\n`;
      context += `  - Vocabulary Richness: {{ plagiarism_data.component_scores.vocabulary_richness | default(0) }}%\n`;
      context += `  - Phrase Originality: {{ plagiarism_data.component_scores.phrase_originality | default(0) }}%\n`;
      context += `  - Style Consistency: {{ plagiarism_data.component_scores.style_consistency | default(0) }}%\n`;
      {% endif %}
      {% if plagiarism_data.issues %}
      context += "Issues Found:\n";
      {% for issue in plagiarism_data.issues[:5] %}
      context += `  - {{ issue.title | default('Issue') }}: {{ issue.description | default('') }}\n`;
      {% endfor %}
      {% endif %}
      context += "\n";
      {% endif %}
      
      // Get citation analysis details
      {% if citation_data %}
      context += "--- Citation Analysis Results ---\n";
      context += `Citation Score: {{ citation_data.citation_score | default(0) }}/100\n`;
      context += `Total Citations: {{ citation_data.total_citations | default(0) }}\n`;
      context += `Total References: {{ citation_data.total_references | default(0) }}\n`;
      {% if citation_data.citation_density %}
      context += `Citations per 1000 words: {{ citation_data.citation_density.citations_per_1000_words | default(0) }}\n`;
      {% endif %}
      {% if citation_data.issues %}
      context += "Citation Issues:\n";
      {% for issue in citation_data.issues[:5] %}
      context += `  - [{{ issue.severity | default('info') | upper }}] {{ issue.title | default('Issue') }}: {{ issue.description | default('') }}\n`;
      {% endfor %}
      {% endif %}
      {% if citation_data.unsupported_claims %}
      context += "Unsupported Claims Found: {{ citation_data.unsupported_claims | length }}\n";
      {% for claim in citation_data.unsupported_claims[:3] %}
      context += `  - "{{ claim.text[:80] | default('') }}..."\n`;
      {% endfor %}
      {% endif %}
      context += "\n";
      {% endif %}
      
      // Get formatting suggestions
      {% if formatting_data and formatting_data.pages %}
      context += "--- Formatting Suggestions ---\n";
      context += `Overall Format Score: {{ formatting_data.score | default(0) }}/100\n`;
      {% if formatting_data.overall and formatting_data.overall.grade %}
      context += `Grade: {{ formatting_data.overall.grade }}\n`;
      {% endif %}
      let suggestionCount = 0;
      {% for page in formatting_data.pages[:3] %}
      {% for sugg in page.suggestions[:3] %}
      context += `  - [{{ sugg.type | default('info') | upper }}] {{ sugg.title | default('Suggestion') }}: {{ sugg.description | default('') }}\n`;
      suggestionCount++;
      {% endfor %}
      {% endfor %}
      context += "\n";
      {% endif %}
      
      // Get rewrite opportunities
      {% if rewrite_data and rewrite_data.opportunities %}
      context += "--- Rewrite Opportunities ---\n";
      context += `Total Opportunities: {{ rewrite_data.stats.total_opportunities | default(0) }}\n`;
      context += `High Priority: {{ rewrite_data.stats.high_count | default(0) }}\n`;
      context += `Medium Priority: {{ rewrite_data.stats.medium_count | default(0) }}\n`;
      {% for opp in rewrite_data.opportunities[:5] %}
      context += `  - [{{ opp.priority | default('medium') | upper }}] {{ opp.type | default('improvement') }}: {{ opp.description[:100] | default('') }}\n`;
      {% endfor %}
      context += "\n";
      {% endif %}
      
      context += "=== END OF ANALYSIS CONTEXT ===\n";
      context += "\nPlease use this analysis data to provide specific, actionable advice about this research paper.\n";
      
      return context;
    }

    // Send message to chat API
    async function sendChat() {
      const message = chatInput.value.trim();
      if (!message) return;

      // Disable input while processing
      chatInput.value = '';
      chatSendBtn.disabled = true;

      // Add user message
      addMessage(message, true);
      showTyping();

      try {
        // Get paper context for the AI
        const paperContext = getPaperContext();
        
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: message,
            context: paperContext
          })
        });

        const data = await response.json();
        removeTyping();

        if (data.error) {
          addMessage('Sorry, I encountered an error: ' + data.error);
        } else {
          addMessage(data.reply || 'I apologize, but I could not generate a response.');
        }
      } catch (error) {
        removeTyping();
        addMessage('Sorry, there was an error connecting to the AI service. Please try again.');
        console.error('Chat error:', error);
      } finally {
        chatSendBtn.disabled = false;
        chatInput.focus();
      }
    }

    // Chat event listeners
    if (chatSendBtn) {
      chatSendBtn.addEventListener('click', sendChat);
    }

    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });
    }
  </script>
</body>
</html>
